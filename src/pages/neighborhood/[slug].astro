---
import BaseLayout from "../../layouts/Base.astro";
import { businesses } from "../../lib/businesses";

/** URL-friendly slug helper (for template use) */
function neighborhoodSlug(n: string): string {
  return String(n || "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/** Title-case helper */
function titleCase(str: string): string {
  return String(str || "")
    .toLowerCase()
    .split(" ")
    .filter(Boolean)
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

/** Amenity icons (same as type page) */
function getAmenityIcon(tag: string): string {
  const icons: Record<string, string> = {
    takeout: "ü•°",
    "dine-in": "üçΩÔ∏è",
    "outdoor seating": "üå≥",
    delivery: "üöö",
    "vegan options": "üå±",
    "live entertainment": "üéµ",
    "lgbtq+ friendly": "üè≥Ô∏è‚Äçüåà",
    "wine and beer": "üç∑",
    "parking available": "üÖøÔ∏è",
    "pet-friendly patio": "üêæ",
    "live music": "üé∏",
    "free admission": "üéüÔ∏è",
    "artist talks": "üé®",
    "workshop space": "üõ†Ô∏è",
  };
  return icons[String(tag || "").toLowerCase()] || "‚úì";
}

/** SSG */
export function getStaticPaths() {
  // ‚úÖ Inline helper ensures it ALWAYS exists inside getStaticPaths evaluation
  const slug = (n: string): string =>
    String(n || "")
      .toLowerCase()
      .trim()
      .replace(/&/g, "and")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "");

  const names = Array.from(
    new Set(
      businesses.flatMap((b) =>
        Array.isArray(b.neighborhoods) ? b.neighborhoods : []
      )
    )
  )
    .filter(Boolean)
    .map((n) => String(n).trim())
    .filter(Boolean);

  const slugToNeighborhood = new Map<string, string>();
  for (const name of names) {
    const s = slug(name);
    if (s && !slugToNeighborhood.has(s)) slugToNeighborhood.set(s, name);
  }

  // Optional: include /neighborhood/mobile/ even if not present in data
  if (!slugToNeighborhood.has("mobile")) {
    slugToNeighborhood.set("mobile", "Mobile");
  }

  return Array.from(slugToNeighborhood.entries()).map(([slugValue, name]) => ({
    params: { slug: slugValue },
    props: { neighborhoodName: name },
  }));
}

/** Page params/props */
const { slug } = Astro.params;
const { neighborhoodName } = Astro.props as { neighborhoodName: string };

const isMobile =
  slug === "mobile" || String(neighborhoodName || "").toLowerCase() === "mobile";

const displayNeighborhood = isMobile ? "Mobile" : titleCase(neighborhoodName);

/** Enhance businesses with primaryType (same logic as type page) */
const enhanced = businesses.map((b) => ({
  ...b,
  primaryType:
    b.type ||
    (Array.isArray(b.businessCategories) && b.businessCategories[0]) ||
    "Other",
}));

/** Filter to this neighborhood */
let filtered = enhanced.filter(
  (b) =>
    Array.isArray(b.neighborhoods) &&
    b.neighborhoods.includes(neighborhoodName)
);

const hasResults = filtered.length > 0;

/** Filters */
const primaryTypes = Array.from(
  new Set(filtered.flatMap((b) => b.cuisineTypes || []))
).sort();

const allMicrofilters = Array.from(
  new Set(filtered.flatMap((b) => b.microfilters || []))
).sort();

/** Map locations */
const locationsForMap = filtered
  .filter((b) => b.latitude && b.longitude)
  .map((b) => ({
    slug: b.slug,
    name: b.name,
    lat: b.latitude,
    lng: b.longitude,
    neighborhoods: b.neighborhoods || [],
  }));

/** Search placeholder */
const searchPlaceholder = isMobile
  ? "Try: soul food, BBQ, catering"
  : `Try: brunch, coffee, ${displayNeighborhood}`;

/** -------------------------
 * ‚úÖ SEO (added/cleaned, no UI changes)
 * ------------------------ */



const pageImage = "/og-denver-black-guide.png";
const pageTitle = isMobile
  ? "Mobile & Pop-Up Black-Owned Businesses ‚Ä¢ Denver Black Guide"
  : `Black-Owned Businesses in ${displayNeighborhood} ‚Ä¢ Denver Black Guide`;

const pageDescription = isMobile
  ? "Browse mobile and pop-up Black-owned businesses serving the Denver metro area."
  : `Explore Black-owned restaurants in ${displayNeighborhood}, Denver. Filter by cuisine and amenities, and view locations on the map.`;

// Prefer SITE_URL / Astro.site for absolute canonical (Netlify friendly)
const origin =
  import.meta.env.SITE_URL ||
  Astro.site ||
  Astro.url.origin;

   const siteUrl = new URL("/", origin).toString();

// ‚úÖ trailingSlash: "never" friendly canonical
const canonicalPath = (Astro.url.pathname || "/").replace(/\/$/, "") || "/";
const canonical = new URL(canonicalPath, origin).toString();

const params = Astro.url.searchParams;
const isFiltered =
  params.has("q") ||
  params.has("cuisine") ||
  params.has("amenity") ||
  params.has("sort");

// ‚úÖ WebPage + ItemList + Breadcrumbs
const listItems = filtered.slice(0, 100).map((b, i) => ({
  "@type": "ListItem",
  position: i + 1,
  name: b.name,
  url: new URL(`/business/${b.slug}`, origin).toString(),
}));

const breadcrumbId = `${canonical}#breadcrumb`;

const breadcrumbJsonLd = {
  "@id": breadcrumbId,
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: siteUrl },
    { "@type": "ListItem", position: 2, name: "Neighborhoods", item: new URL("/neighborhood", origin).toString() },
    { "@type": "ListItem", position: 3, name: displayNeighborhood, item: canonical },
  ],
};

const jsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebPage",
      name: pageTitle,
      url: canonical,
      description: pageDescription,
      primaryImageOfPage: {
        "@type": "ImageObject",
        url: new URL(pageImage, origin).toString(),
      },
      // nice-to-have connections to Base.astro global ids (doesn't break if absent)
      isPartOf: { "@id": `${siteUrl}#website` },
      publisher: { "@id": `${siteUrl}#organization` },
       breadcrumb: { "@id": breadcrumbId },
    },
    {
      "@type": "ItemList",
      name: isMobile
        ? "Mobile & Pop-Up Black-Owned Businesses in Denver"
        : `Black-Owned Restaurants in ${displayNeighborhood}`,
      itemListOrder: "https://schema.org/ItemListOrderAscending",
      numberOfItems: filtered.length,
      itemListElement: listItems,
    },
    breadcrumbJsonLd,
  ],
};

const robots = !hasResults
  ? "noindex,follow"
  : isFiltered
    ? "noindex,follow"
    : "index,follow,max-image-preview:large";


if (!hasResults) {
  Astro.response.status = 404;
}
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  image={pageImage}
  canonical={canonical}
  jsonLd={jsonLd}
  robots={robots}
>
  
    <!-- ‚úÖ Small SEO extras (no UI impact) -->
    <meta slot="head" name="author" content="Denver Black Guide" />
    <meta slot="head" property="og:site_name" content="Denver Black Guide" />
    <meta slot="head" property="og:locale" content="en_US" />
    <meta slot="head" property="og:image:alt" content="Denver Black Guide directory preview" />
    <meta slot="head" name="twitter:image:alt" content="Denver Black Guide directory preview" />

  

  <div class="directory">
    <nav aria-label="Breadcrumb" class="directory__breadcrumb">
      <a href="/" class="directory__breadcrumb-link">Home</a>
      <span aria-hidden="true">/</span>
      <a href="/neighborhood" class="directory__breadcrumb-link">Neighborhoods</a>
      <span aria-hidden="true">/</span>
      <span class="directory__breadcrumb-current">{displayNeighborhood}</span>
    </nav>

    <header class="directory__head">
      <h1 class="directory__title">
        {isMobile ? "Mobile & Pop-Up Businesses" : `Restaurants in ${displayNeighborhood}`}
      </h1>
      <p class="directory__subtitle">
        {isMobile
          ? "These businesses may not have one fixed neighborhood. Check each listing for current locations and scheduling."
          : `Explore restaurants listed in ${displayNeighborhood} ‚Äî filter by cuisine and amenities.`}
      </p>
    </header>

    <section
      class="filter-panel"
      id="filters"
      aria-label={`${displayNeighborhood} filters`}
      data-collapsed="true"
    >
      <button class="filter-panel__toggle" id="filter-toggle" type="button">
        <span id="filter-toggle-text">Show Filters</span>
        <span class="filter-badge" id="filter-count">0</span>
        <span class="filter-toggle__icon">‚ñº</span>
      </button>

      <div class="filter-panel__content">
        <div class="filter-row filter-row--top">
          <div class="filter-search-wrap">
            <label for="search" class="filter-label">Search</label>
            <div class="filter-search">
              <svg class="filter-search__icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path
                  d="M7 13A6 6 0 1 0 7 1a6 6 0 0 0 0 12zM14 14l-3-3"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>

              <input
                id="search"
                name="directory-search"
                type="search"
                class="filter-search__input"
                placeholder={searchPlaceholder}
                autocomplete="off"
                autocapitalize="none"
                spellcheck="false"
              />

              <button
                type="button"
                id="search-clear"
                class="filter-search__clear"
                aria-label="Clear search"
              >
                ‚úï
              </button>
            </div>
          </div>

          <div class="filter-sort-wrap">
            <label for="sort" class="filter-label">Sort by</label>
            <select id="sort" class="filter-sort">
              <option value="az">A‚ÄìZ (Name)</option>
              <option value="cuisine">Cuisine</option>
            </select>
          </div>
        </div>

        <div class="filter-dropdowns">
          {primaryTypes.length > 0 && (
            <div class="filter-dropdown">
              <label for="primary-select" class="filter-label">Cuisine</label>
              <select id="primary-select" class="filter-select" multiple size="4">
                {primaryTypes.map((c) => (
                  <option value={c.toLowerCase()}>{c}</option>
                ))}
              </select>
              <p class="filter-dropdown__hint">Hold Ctrl/Cmd to select multiple</p>
            </div>
          )}

          {allMicrofilters.length > 0 && (
            <div class="filter-dropdown">
              <label for="amenities-select" class="filter-label">Amenities &amp; Options</label>
              <select id="amenities-select" class="filter-select" multiple size="4">
                {allMicrofilters.map((m) => (
                  <option value={m.toLowerCase()}>{m}</option>
                ))}
              </select>
              <p class="filter-dropdown__hint">Hold Ctrl/Cmd to select multiple</p>
            </div>
          )}
        </div>

        <div class="filter-row filter-row--actions">
          <button type="button" id="reset-all-filters" class="btn-reset-all">
            Clear all filters
          </button>
        </div>
      </div>
    </section>

    <div id="active-filters-summary" class="active-filters" style="display: none;">
      <span class="active-filters__label">Active:</span>
      <div id="active-filters-list" class="active-filters__list"></div>
    </div>

    <button class="map-toggle" id="map-toggle" type="button">
      <span id="map-toggle-text">üìç Show Map</span>
    </button>

    <div class="split-container" id="split-container">
      <section class="map-section" id="map-section" aria-label="Map view">
        <div id="map" class="map-view"></div>
        <div class="map-overlay">
          <p class="map-overlay__text">
            <span id="map-marker-count">{locationsForMap.length}</span> locations
          </p>
        </div>
      </section>

      <section aria-label="Results" class="directory__results">
        <p id="results-count" class="directory__results-count">
          Showing {filtered.length} place{filtered.length === 1 ? "" : "s"}
        </p>

        <div id="empty-state" class="empty-state" style="display: none;">
          <div class="empty-state__icon">üîç</div>
          <h3 class="empty-state__title">No businesses found</h3>
          <p class="empty-state__message">Try adjusting your filters or search terms</p>
          <button id="reset-from-empty" class="empty-state__button">Clear all filters</button>
        </div>

        <div id="results-grid" class="directory__grid">
          {filtered.map((b) => {
            const name = b.name || "";
            const cuisines = b.cuisineTypes || [];
            const neighborhoods = b.neighborhoods || [];
            const microfilters = b.microfilters || [];

            return (
              <a
                href={`/business/${b.slug}`}
                class="business-card-link"
                data-slug={b.slug}
                data-name={name.toLowerCase()}
                data-primary-types={cuisines.join("|").toLowerCase()}
                data-neighborhoods={neighborhoods.join("|").toLowerCase()}
                data-microfilters={microfilters.join("|").toLowerCase()}
                data-lat={b.latitude}
                data-lng={b.longitude}
              >
                <article class="card business-card">
                  <h2 class="business-card__name">{name}</h2>

                  <div class="business-card__quick-info">
                    <span class="quick-info-item">
                      <span class="quick-info-item__icon">üìç</span>

                      {neighborhoods.length > 0 ? (
                        <span class="neighborhood-chip-row">
                          {neighborhoods.slice(0, 2).map((n) => (
                            <button
                              type="button"
                              class="neighborhood-chip"
                              data-neighborhood-slug={neighborhoodSlug(n)}
                              aria-label={`View businesses in ${n}`}
                            >
                              {n}
                            </button>
                          ))}
                          {neighborhoods.length > 2 && (
                            <span class="neighborhood-more">
                              +{neighborhoods.length - 2}
                            </span>
                          )}
                        </span>
                      ) : (
                        <span>{"Location TBD"}</span>
                      )}
                    </span>

                    {b.yearEstablished && (
                      <span class="quick-info-item">
                        <span class="quick-info-item__icon">üìÖ</span>
                        Est. {b.yearEstablished}
                      </span>
                    )}
                  </div>

                  <p class="business-card__meta">
                    {cuisines.length > 0 ? (
                      <>
                        <span class="business-card__type">Cuisine:</span>{" "}
                        <span>{cuisines.join(", ")}</span>
                      </>
                    ) : (
                      <span class="business-card__type">Restaurant</span>
                    )}
                  </p>

                  {microfilters.length > 0 && (
                    <div class="business-card__amenities">
                      {microfilters.slice(0, 3).map((tag) => (
                        <span class="amenity-tag" title={tag}>
                          <span class="amenity-tag__icon">{getAmenityIcon(tag)}</span>
                          <span class="amenity-tag__label">{tag}</span>
                        </span>
                      ))}
                      {microfilters.length > 3 && (
                        <span class="business-card__more">
                          +{microfilters.length - 3} more
                        </span>
                      )}
                    </div>
                  )}

                  <div class="business-card__action">View Details ‚Üí</div>
                </article>
              </a>
            );
          })}
        </div>
      </section>
    </div>
  </div>

  <!-- ‚úÖ CSS (same as your type page) -->
  <style>
    .directory { display: flex; flex-direction: column; gap: 1.5rem; }

    .directory__breadcrumb {
      display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;
      color: var(--text-muted); margin-bottom: 0.25rem; flex-wrap: wrap;
    }
    .directory__breadcrumb-link { text-decoration: none; color: inherit; }
    .directory__breadcrumb-link:hover { text-decoration: underline; }
    .directory__breadcrumb-current { font-weight: 600; }

    .directory__head { margin-bottom: 0.25rem; }
    .directory__title { margin: 0; font-size: 1.6rem; line-height: 1.2; }
    .directory__subtitle {
      margin: 0.35rem 0 0; font-size: 0.9rem; color: var(--text-muted); max-width: 42rem;
    }

    .filter-panel {
      border-radius: 0.9rem; border: 1px solid var(--border-subtle);
      background: var(--bg-elevated); box-shadow: var(--shadow-soft);
      padding: 0.9rem 1rem 1rem; display: flex; flex-direction: column; gap: 0.75rem;
    }

    .filter-panel__toggle {
      display: none; width: 100%; align-items: center; justify-content: space-between;
      padding: 0.75rem 1rem; background: transparent; border: none; cursor: pointer;
      font-size: 0.9rem; font-weight: 600; color: var(--text-main); gap: 0.75rem;
    }

    .filter-badge {
      background: var(--accent); color: white; padding: 0.15rem 0.5rem; border-radius: 9999px;
      font-size: 0.7rem; font-weight: 600; min-width: 1.5rem; text-align: center;
    }

    .filter-toggle__icon { font-size: 0.75rem; transition: transform 0.2s; }
    .filter-panel[data-collapsed="false"] .filter-toggle__icon { transform: rotate(180deg); }

    @media (max-width: 768px) {
      .filter-panel__toggle { display: flex; }
      .filter-panel[data-collapsed="true"] .filter-panel__content { display: none; }
      .filter-panel { padding: 0; }
      .filter-panel__content { padding: 0.9rem 1rem 1rem; }
    }

    .filter-row { display: flex; flex-wrap: wrap; gap: 0.4rem 0.6rem; align-items: flex-start; }
    .filter-row--top { align-items: flex-end; gap: 0.75rem; flex-wrap: wrap; }
    .filter-row--actions { justify-content: flex-end; padding-top: 0.5rem; border-top: 1px solid var(--border-subtle); }

    .filter-search-wrap { flex: 1 1 220px; min-width: 0; }
    .filter-sort-wrap { flex: 0 0 auto; min-width: 150px; }

    .filter-label {
      display: block; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.05em;
      text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.15rem;
    }

    .filter-search { position: relative; display: flex; align-items: center; }
    .filter-search__icon { position: absolute; left: 0.75rem; color: var(--text-muted); pointer-events: none; opacity: 0.7; }

    .filter-search__input {
      width: 100%; border-radius: 9999px; border: 1px solid var(--border-subtle);
      background: var(--bg-page); padding: 0.4rem 2rem 0.4rem 2.5rem; font-size: 0.85rem;
    }
    .filter-search__input:focus-visible { outline: 2px solid var(--accent); outline-offset: 1px; }

    .filter-search__clear {
      position: absolute; right: 0.4rem; border: none; background: transparent; font-size: 0.8rem;
      cursor: pointer; color: var(--text-muted); padding: 0.1rem; opacity: 0; pointer-events: none;
      transition: opacity 0.15s;
    }
    .filter-search__clear.is-visible { opacity: 1; pointer-events: auto; }

    .filter-sort {
      width: 100%; border-radius: 9999px; border: 1px solid var(--border-subtle);
      background: var(--bg-page); padding: 0.35rem 0.75rem; font-size: 0.8rem;
    }

    .filter-dropdowns {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem; margin-top: 0.5rem;
    }

    .filter-select {
      width: 100%; padding: 0.5rem 0.75rem; border-radius: 0.5rem;
      border: 1px solid var(--border-subtle); background: var(--bg-page);
      font-size: 0.85rem; color: var(--text-main); cursor: pointer;
    }
    .filter-select[multiple] { min-height: 120px; padding: 0.25rem; }

    .filter-dropdown__hint { margin: 0.25rem 0 0; font-size: 0.65rem; color: var(--text-muted); font-style: italic; }

    .btn-reset-all {
      padding: 0.4rem 1rem; border-radius: 9999px; border: 1px solid var(--border-subtle);
      background: transparent; font-size: 0.8rem; color: var(--text-muted);
      cursor: pointer; transition: all 0.15s;
    }
    .btn-reset-all:hover { border-color: var(--accent); color: var(--accent-strong); background: var(--accent-soft); }

    .active-filters {
      display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem;
      background: var(--bg-elevated); border-radius: 0.5rem; border: 1px solid var(--border-subtle);
      flex-wrap: wrap;
    }
    .active-filters__label {
      font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.05em;
    }
    .active-filters__list { display: flex; flex-wrap: wrap; gap: 0.35rem; flex: 1; }

    .empty-state { text-align: center; padding: 3rem 1rem; }

    @keyframes pulse {
      0%,100% { box-shadow: 0 2px 6px rgba(0,0,0,0.3), 0 0 0 0 rgba(0,0,0,0); }
      50% { box-shadow: 0 2px 6px rgba(0,0,0,0.3), 0 0 0 8px rgba(0,0,0,0.12); }
    }

    .map-toggle {
      display: none; width: 100%; padding: 0.75rem 1.25rem;
      background: var(--accent); color: white; border: none; border-radius: 0.75rem;
      font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .map-toggle:hover { background: var(--accent-strong); transform: translateY(-1px); }
    @media (max-width: 768px) { .map-toggle { display: block; } }

    .split-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: start; }
    @media (max-width: 768px) {
      .split-container { grid-template-columns: 1fr; }
      .map-section { display: none; }
      .map-section.is-visible { display: block; margin-bottom: 1rem; }
    }

    .map-section {
      position: sticky; top: 1rem; height: calc(100vh - 2rem); min-height: 500px;
      border-radius: 1rem; overflow: hidden; border: 1px solid var(--border-subtle); background: var(--bg-elevated);
    }
    @media (max-width: 768px) {
      .map-section { position: relative; top: 0; height: 450px; min-height: 400px; }
    }

    .map-view { width: 100%; height: 100%; }
    .map-overlay {
      position: absolute; top: 1rem; left: 1rem; background: white; padding: 0.5rem 1rem;
      border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000;
    }

    .directory__results { display: flex; flex-direction: column; gap: 0.75rem; min-width: 0; }
    .directory__results-count { margin: 0; font-size: 0.8rem; color: var(--text-muted); }

    .directory__grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 0.9rem; }
    .business-card-link { text-decoration: none; color: inherit; display: block; }

    .business-card {
      padding: 1rem 1.1rem 1.1rem; display: flex; flex-direction: column; gap: 0.5rem;
      position: relative; transition: transform 0.15s, box-shadow 0.15s; height: 100%;
    }
    .business-card-link:hover .business-card { transform: translateY(-2px); box-shadow: var(--shadow-soft); }
    .business-card.is-highlighted { border-color: var(--accent); background: var(--accent-soft); transform: translateY(-2px); box-shadow: var(--shadow-soft); }

    .business-card__name { margin: 0 0 0.1rem; font-size: 1rem; color: var(--text-main); }
    .quick-info-item { display: flex; align-items: center; gap: 0.25rem; }
    .quick-info-item__icon { font-size: 0.85rem; }
    .business-card__meta { margin: 0; font-size: 0.8rem; color: var(--text-muted); }
    .business-card__type { font-weight: 600; }

    .business-card__amenities { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.25rem; }
    .amenity-tag {
      display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.2rem 0.5rem;
      background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 0.35rem;
      font-size: 0.7rem; color: var(--text-main);
    }
    .amenity-tag__icon { font-size: 0.85rem; }
    .business-card__more { font-size: 0.7rem; color: var(--text-muted); padding: 0.2rem 0.5rem; }

    .business-card__action {
      margin-top: auto; padding-top: 0.5rem; font-size: 0.8rem; color: var(--accent);
      font-weight: 500; opacity: 0; transition: opacity 0.15s;
    }
    .business-card:hover .business-card__action { opacity: 1; }

    .neighborhood-chip-row { display: inline-flex; gap: 0.35rem; flex-wrap: wrap; align-items: center; }
    .neighborhood-chip {
      border: none; background: transparent; padding: 0; cursor: pointer;
      color: var(--accent); font-weight: 600; font-size: 0.8rem; text-decoration: underline; text-underline-offset: 2px;
    }
    .neighborhood-chip:hover { color: var(--accent-strong); }
    .neighborhood-chip:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 0.35rem; }
    .neighborhood-more { font-size: 0.75rem; color: var(--text-muted); }
  </style>

  <script is:inline define:vars={{ mapLocations: locationsForMap }}>
    window.addEventListener("load", function () {
      if (typeof window.L === "undefined") return;

      const markerCountEl = document.getElementById("map-marker-count");
      const mapSection = document.getElementById("map-section");
      const mapToggle = document.getElementById("map-toggle");
      const mapToggleText = document.getElementById("map-toggle-text");

      const map = window.L.map("map").setView([39.7392, -104.9903], 12);
      window.L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
        { maxZoom: 19 }
      ).addTo(map);

      const customIcon = window.L.divIcon({
        className: "custom-marker",
        html: '<div style="background: var(--accent); width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
        iconSize: [24, 24],
        iconAnchor: [12, 12],
      });

      const markers = {};
      const markerGroup = window.L.featureGroup().addTo(map);

      (mapLocations || []).forEach((location) => {
        if (!location.lat || !location.lng) return;

        const marker = window.L.marker([location.lat, location.lng], { icon: customIcon }).addTo(markerGroup);

        marker.bindPopup(`
          <div style="padding: 0.5rem;">
            <h3 style="margin: 0 0 0.25rem; font-size: 0.95rem;">
              <a href="/business/${location.slug}" style="color: var(--accent); text-decoration: none;">
                ${location.name}
              </a>
            </h3>
            <p style="margin: 0; font-size: 0.75rem; color: var(--text-muted);">
              ${
                (location.neighborhoods && location.neighborhoods.length > 0)
                  ? location.neighborhoods[0]
                  : "Denver"
              }
            </p>
          </div>
        `);

        markers[location.slug] = marker;

        marker.on("click", () => {
          const cardLink = document.querySelector(`.business-card-link[data-slug="${location.slug}"]`);
          if (cardLink) {
            cardLink.scrollIntoView({ behavior: "smooth", block: "center" });
            const card = cardLink.querySelector(".business-card");
            if (card) {
              card.classList.add("is-highlighted");
              setTimeout(() => card.classList.remove("is-highlighted"), 2000);
            }
          }
        });
      });

      if (markerGroup.getBounds().isValid()) {
        map.fitBounds(markerGroup.getBounds(), { padding: [50, 50] });
      }

      function updateMarkerCount() {
        const visibleCardLinks = document.querySelectorAll(
          '.business-card-link:not([style*="display: none"])'
        );
        const visibleSlugs = Array.from(visibleCardLinks).map((c) => c.dataset.slug);

        let visibleCount = 0;
        Object.entries(markers).forEach(([slug, marker]) => {
          if (visibleSlugs.includes(slug)) {
            markerGroup.addLayer(marker);
            visibleCount++;
          } else {
            markerGroup.removeLayer(marker);
          }
        });

        if (markerCountEl) markerCountEl.textContent = String(visibleCount);

        if (markerGroup.getBounds().isValid()) {
          map.fitBounds(markerGroup.getBounds(), { padding: [50, 50] });
        }
      }

      document.querySelectorAll(".business-card-link").forEach((cardLink) => {
        const slug = cardLink.dataset.slug;
        if (!slug) return;

        function setPulse(on) {
          const marker = markers[slug];
          if (!marker) return;
          setTimeout(() => {
            const markerEl = marker.getElement?.();
            if (!markerEl) return;
            const dot = markerEl.querySelector("div");
            if (!dot) return;

            if (on) {
              dot.style.animation = "pulse 1s ease-in-out infinite";
              dot.style.transform = "scale(1.5)";
              dot.style.transition = "transform 0.2s ease";
              markerEl.style.zIndex = "1000";
            } else {
              dot.style.animation = "";
              dot.style.transform = "scale(1)";
              markerEl.style.zIndex = "";
            }
          }, 10);
        }

        cardLink.addEventListener("mouseenter", () => setPulse(true));
        cardLink.addEventListener("mouseleave", () => setPulse(false));
        cardLink.addEventListener("focus", () => setPulse(true));
        cardLink.addEventListener("blur", () => setPulse(false));
      });

      if (mapToggle && mapSection && mapToggleText) {
        mapToggle.addEventListener("click", () => {
          const isVisible = mapSection.classList.contains("is-visible");
          if (isVisible) {
            mapSection.classList.remove("is-visible");
            mapToggleText.textContent = "üìç Show Map";
          } else {
            mapSection.classList.add("is-visible");
            mapToggleText.textContent = "üìç Hide Map";
            setTimeout(() => map.invalidateSize(), 100);
          }
        });
      }

      window.updateMapMarkers = updateMarkerCount;
      updateMarkerCount();
    });

    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".neighborhood-chip");
      if (!btn) return;

      e.preventDefault();
      e.stopPropagation();

      const slug = btn.dataset.neighborhoodSlug;
      if (!slug) return;

      window.location.href = `/neighborhood/${slug}`;
    });

    document.addEventListener("keydown", (e) => {
      if (e.key !== "Enter" && e.key !== " ") return;

      const btn = document.activeElement?.closest?.(".neighborhood-chip");
      if (!btn) return;

      e.preventDefault();
      e.stopPropagation();

      const slug = btn.dataset.neighborhoodSlug;
      if (!slug) return;

      window.location.href = `/neighborhood/${slug}`;
    });
  </script>

  <script>
    const searchInput = document.getElementById("search");
    const clearBtn = document.getElementById("search-clear");
    const sortSelect = document.getElementById("sort");
    const primarySelect = document.getElementById("primary-select");
    const amenitiesSelect = document.getElementById("amenities-select");
    const grid = document.getElementById("results-grid");
    const countEl = document.getElementById("results-count");
    const emptyState = document.getElementById("empty-state");
    const filterToggle = document.getElementById("filter-toggle");
    const filterToggleText = document.getElementById("filter-toggle-text");
    const filterPanel = document.getElementById("filters");
    const filterCount = document.getElementById("filter-count");
    const activeFiltersSummary = document.getElementById("active-filters-summary");
    const activeFiltersList = document.getElementById("active-filters-list");
    const resetAllBtn = document.getElementById("reset-all-filters");
    const resetFromEmpty = document.getElementById("reset-from-empty");

    const cards = Array.from(document.querySelectorAll("#results-grid .business-card-link"));

    function normalize(str) {
      return (str || "").toLowerCase().trim();
    }

    function getSelectedValues(selectElement) {
      if (!selectElement) return new Set();
      const selected = Array.from(selectElement.selectedOptions || []);
      return new Set(selected.map((opt) => normalize(opt.value)));
    }

    function updateClearButton() {
      if (!clearBtn || !searchInput) return;
      const hasValue = !!searchInput.value.trim();
      clearBtn.classList.toggle("is-visible", hasValue);
    }

    function getActiveFilterCount() {
      let count = 0;
      if (primarySelect) count += primarySelect.selectedOptions.length;
      if (amenitiesSelect) count += amenitiesSelect.selectedOptions.length;
      if (searchInput && searchInput.value.trim()) count++;
      return count;
    }

    function updateFilterCount() {
      const count = getActiveFilterCount();
      if (filterCount) {
        filterCount.textContent = String(count);
        filterCount.style.display = count > 0 ? "" : "none";
      }
    }

    function updateActiveFiltersSummary() {
      const count = getActiveFilterCount();
      if (!activeFiltersSummary || !activeFiltersList) return;

      if (count === 0) {
        activeFiltersSummary.style.display = "none";
        activeFiltersList.innerHTML = "";
        return;
      }

      activeFiltersSummary.style.display = "flex";

      let html = "";

      if (primarySelect) {
        Array.from(primarySelect.selectedOptions).forEach((opt) => {
          html += `<span class="active-filter-pill">
            ${opt.text}
            <button class="active-filter-pill__remove" data-clear="primary" data-value="${opt.value}">√ó</button>
          </span>`;
        });
      }

      if (amenitiesSelect) {
        Array.from(amenitiesSelect.selectedOptions).forEach((opt) => {
          html += `<span class="active-filter-pill">
            ${opt.text}
            <button class="active-filter-pill__remove" data-clear="amenity" data-value="${opt.value}">√ó</button>
          </span>`;
        });
      }

      if (searchInput && searchInput.value.trim()) {
        html += `<span class="active-filter-pill">
          üîé ${searchInput.value.trim()}
          <button class="active-filter-pill__remove" data-clear="search">√ó</button>
        </span>`;
      }

      activeFiltersList.innerHTML = html;

      activeFiltersList.querySelectorAll("[data-clear]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const clearType = btn.dataset.clear;
          const value = btn.dataset.value;

          if (clearType === "search" && searchInput) {
            searchInput.value = "";
          } else if (clearType === "primary" && value && primarySelect) {
            Array.from(primarySelect.options).forEach((opt) => {
              if (opt.value === value) opt.selected = false;
            });
          } else if (clearType === "amenity" && value && amenitiesSelect) {
            Array.from(amenitiesSelect.options).forEach((opt) => {
              if (opt.value === value) opt.selected = false;
            });
          }

          applyFiltersAndSort();
        });
      });
    }

    function resetAllFilters() {
      if (searchInput) searchInput.value = "";
      if (primarySelect) Array.from(primarySelect.options).forEach((opt) => (opt.selected = false));
      if (amenitiesSelect) Array.from(amenitiesSelect.options).forEach((opt) => (opt.selected = false));
      applyFiltersAndSort();
    }

    function applyFiltersAndSort() {
      const q = normalize(searchInput?.value || "");
      const sortValue = sortSelect?.value || "az";
      const activePrimaryTypes = getSelectedValues(primarySelect);
      const activeMicrofilters = getSelectedValues(amenitiesSelect);

      const sorted = cards.slice().sort((a, b) => {
        const an = a.dataset.name || "";
        const bn = b.dataset.name || "";

        if (sortValue === "az") return an.localeCompare(bn);

        if (sortValue === "cuisine") {
          const ac = (a.dataset.primaryTypes || "").split("|")[0] || "";
          const bc = (b.dataset.primaryTypes || "").split("|")[0] || "";
          return ac.localeCompare(bc) || an.localeCompare(bn);
        }

        return 0;
      });

      let visible = 0;

      sorted.forEach((card) => {
        const name = card.dataset.name || "";
        const primaryData = card.dataset.primaryTypes || "";
        const neighborhoods = card.dataset.neighborhoods || "";
        const micro = card.dataset.microfilters || "";

        const matchesText =
          !q ||
          name.includes(q) ||
          primaryData.includes(q) ||
          neighborhoods.includes(q) ||
          micro.includes(q);

        const matchesPrimary =
          activePrimaryTypes.size === 0 ||
          Array.from(activePrimaryTypes).some((c) => primaryData.includes(c));

        const matchesMicro =
          activeMicrofilters.size === 0 ||
          Array.from(activeMicrofilters).some((m) => micro.includes(m));

        const show = matchesText && matchesPrimary && matchesMicro;

        card.style.display = show ? "" : "none";
        if (show) {
          visible++;
          grid?.appendChild(card);
        }
      });

      if (countEl) countEl.textContent = `Showing ${visible} place${visible === 1 ? "" : "s"}`;
      if (emptyState) emptyState.style.display = visible === 0 ? "block" : "none";
      if (grid) grid.style.display = visible === 0 ? "none" : "";

      updateClearButton();
      updateFilterCount();
      updateActiveFiltersSummary();

      if (typeof window.updateMapMarkers === "function") window.updateMapMarkers();
    }

    if (filterToggle && filterPanel && filterToggleText) {
      filterToggle.addEventListener("click", () => {
        const isCollapsed = filterPanel.dataset.collapsed === "true";
        filterPanel.dataset.collapsed = isCollapsed ? "false" : "true";
        filterToggleText.textContent = isCollapsed ? "Hide Filters" : "Show Filters";
      });
    }

    searchInput?.addEventListener("input", applyFiltersAndSort);
    clearBtn?.addEventListener("click", () => {
      if (searchInput) {
        searchInput.value = "";
        searchInput.focus();
      }
      applyFiltersAndSort();
    });

    primarySelect?.addEventListener("change", applyFiltersAndSort);
    amenitiesSelect?.addEventListener("change", applyFiltersAndSort);
    sortSelect?.addEventListener("change", applyFiltersAndSort);

    resetAllBtn?.addEventListener("click", resetAllFilters);
    resetFromEmpty?.addEventListener("click", resetAllFilters);

    updateClearButton();
    applyFiltersAndSort();
  </script>
</BaseLayout>
