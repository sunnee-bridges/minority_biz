---
import BaseLayout from "../../layouts/Base.astro";
import { businesses } from "../../lib/businesses";

/** URL-friendly slug (neighborhood) */
function neighborhoodSlug(n: string): string {
  return String(n || "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

/** Title-case helper */
function titleCase(str: string): string {
  return String(str || "")
    .toLowerCase()
    .split(/\s+/)
    .filter(Boolean)
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

/** Build neighborhood list + counts */
const counts = new Map<string, number>();

for (const b of businesses) {
  const arr = Array.isArray(b.neighborhoods) ? b.neighborhoods : [];
  for (const n of arr) {
    const name = String(n || "").replace(/\s+/g, " ").trim();
    if (!name) continue;
    if (name.toLowerCase() === "location tbd") continue;
    counts.set(name, (counts.get(name) || 0) + 1);
  }
}

/** Dedupe by slug */
const slugToName = new Map<string, string>();
const slugToCount = new Map<string, number>();

function preferLabel(existing: string, candidate: string) {
  const a = String(existing || "").trim();
  const b = String(candidate || "").trim();
  if (!a) return b;
  if (!b) return a;

  const lettersA = a.replace(/[^a-z]/gi, "").length;
  const lettersB = b.replace(/[^a-z]/gi, "").length;
  if (lettersB > lettersA) return b;
  if (b.length > a.length) return b;
  return a;
}

for (const [name, count] of counts.entries()) {
  const slug = neighborhoodSlug(name);
  if (!slug) continue;

  const prev = slugToName.get(slug);
  slugToName.set(slug, prev ? preferLabel(prev, name) : name);

  slugToCount.set(slug, (slugToCount.get(slug) || 0) + count);
}

// Ensure "Mobile" exists as a bucket link
if (!slugToName.has("mobile")) {
  slugToName.set("mobile", "Mobile");
  slugToCount.set("mobile", slugToCount.get("mobile") || 0);
}

const neighborhoods = Array.from(slugToName.entries())
  .map(([slug, name]) => ({
    slug,
    name: titleCase(name),
    rawName: name,
    count: slugToCount.get(slug) || 0,
  }))
  .sort((a, b) => b.count - a.count || a.name.localeCompare(b.name));

/** -------------------------
 * ‚úÖ SEO (unchanged)
 * ------------------------ */
const pageImage = "/og-denver-black-guide.png";
const pageTitle = "Denver Neighborhoods ‚Ä¢ Denver Black Guide";
const pageDescription =
  "Browse Denver neighborhoods and explore Black-owned businesses by area. Use neighborhood pages to filter listings and view locations on the map.";

// Prefer SITE_URL / Astro.site for absolute canonical (Netlify friendly)
const origin = import.meta.env.SITE_URL || Astro.site || Astro.url.origin;

const canonicalPath = (Astro.url.pathname || "/").replace(/\/$/, "") || "/";
const canonical = new URL(canonicalPath, origin).toString();

const siteUrl = new URL("/", origin).toString();
const absoluteImage = new URL(pageImage, origin).toString();

const params = Astro.url.searchParams;
const isFiltered = Array.from(params.keys()).length > 0;

const breadcrumbId = `${canonical}#breadcrumb`;

const breadcrumbJsonLd = {
  "@id": breadcrumbId,
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: siteUrl },
    { "@type": "ListItem", position: 2, name: "Neighborhoods", item: canonical },
  ],
};

const itemListElements = neighborhoods.slice(0, 200).map((n, idx) => ({
  "@type": "ListItem",
  position: idx + 1,
  name: n.name,
  url: new URL(`/neighborhood/${n.slug}`, origin).toString(),
}));

const jsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebPage",
      name: pageTitle,
      url: canonical,
      description: pageDescription,
      primaryImageOfPage: { "@type": "ImageObject", url: absoluteImage },
      isPartOf: { "@id": `${siteUrl}#website` },
      publisher: { "@id": `${siteUrl}#organization` },
      breadcrumb: { "@id": breadcrumbId },
    },
    {
      "@type": "ItemList",
      name: "Denver neighborhoods",
      itemListOrder: "https://schema.org/ItemListOrderDescending",
      numberOfItems: neighborhoods.length,
      itemListElement: itemListElements,
    },
    breadcrumbJsonLd,
  ],
};

const robots = isFiltered ? "noindex,follow" : "index,follow,max-image-preview:large";
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  image={pageImage}
  canonical={canonical}
  jsonLd={jsonLd}
  robots={robots}
>
  <!-- ‚úÖ Small SEO extras (no UI impact) -->
  <meta slot="head" name="author" content="Denver Black Guide" />
  <meta slot="head" property="og:site_name" content="Denver Black Guide" />
  <meta slot="head" property="og:locale" content="en_US" />
  <meta slot="head" property="og:image:alt" content="Denver Black Guide directory preview" />
  <meta slot="head" name="twitter:image:alt" content="Denver Black Guide directory preview" />

  <div class="directory">
    <nav aria-label="Breadcrumb" class="directory__breadcrumb">
      <a href="/" class="directory__breadcrumb-link">Home</a>
      <span aria-hidden="true">/</span>
      <span class="directory__breadcrumb-current">Neighborhoods</span>
    </nav>

    <header class="directory__head">
      <h1 class="directory__title">Denver Neighborhoods</h1>
      <p class="directory__subtitle">
        Browse neighborhood pages to explore Black-owned businesses by area.
      </p>
      <p class="directory__subtitle" style="margin-top:0.5rem;">
        Showing{" "}
        <strong id="visible-count" aria-live="polite">{neighborhoods.length}</strong>{" "}
        neighborhood{neighborhoods.length === 1 ? "" : "s"}.
      </p>
    </header>

    <!-- ‚úÖ Filters (updated UX) -->
    <section
      class="filter-panel"
      aria-label="Neighborhood filters"
      id="filters"
      data-collapsed="true"
    >
      <!-- Mobile toggle -->
      <button class="filter-panel__toggle" id="filter-toggle" type="button">
        <span id="filter-toggle-text">Show Filters</span>
        <span class="filter-badge" id="filter-count">0</span>
        <span class="filter-toggle__icon">‚ñº</span>
      </button>

      <div class="filter-panel__content">
        <div class="filter-row filter-row--top">
          <div class="filter-search-wrap">
            <label for="neighborhood-search" class="filter-label">Search</label>
            <div class="filter-search">
              <svg class="filter-search__icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path
                  d="M7 13A6 6 0 1 0 7 1a6 6 0 0 0 0 12zM14 14l-3-3"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>

              <input
                id="neighborhood-search"
                type="search"
                class="filter-search__input"
                placeholder="Try: Five Points, Park Hill, mobile"
                autocomplete="off"
                autocapitalize="none"
                spellcheck="false"
              />

              <button
                type="button"
                id="neighborhood-search-clear"
                class="filter-search__clear"
                aria-label="Clear search"
              >
                ‚úï
              </button>
            </div>

            <p class="filter-dropdown__hint" style="margin-top:0.35rem;">
              Search filters the checkbox list and the neighborhood cards.
            </p>
          </div>

          <div class="filter-sort-wrap">
            <label for="sort" class="filter-label">Sort by</label>
            <select id="sort" class="filter-sort">
              <option value="count">Most listings</option>
              <option value="az">A‚ÄìZ</option>
            </select>
          </div>
        </div>

        <div class="filter-dropdowns">
          <div class="filter-dropdown">
            <label class="filter-label">Multi-select neighborhoods</label>

            <div class="multi-check">
              <div class="multi-check__actions">
                <button type="button" class="multi-check__btn" id="select-all">Select all shown</button>
                <button type="button" class="multi-check__btn" id="clear-all">Clear shown</button>
              </div>

              <div class="multi-check__list" id="neighborhood-checks">
                {neighborhoods.map((n) => (
                  <label class="multi-check__item">
                    <input
                      class="multi-check__box"
                      type="checkbox"
                      value={n.slug}
                      data-name={n.name.toLowerCase()}
                      data-count={n.count}
                      data-label={n.name}
                    />
                    <span class="multi-check__text">
                      {n.name}
                      <span class="multi-check__muted">
                        {n.slug === "mobile" ? " ‚Ä¢ üöö Mobile & pop-up" : ` ‚Ä¢ ${n.count} listings`}
                      </span>
                    </span>
                  </label>
                ))}
              </div>

              <p class="filter-dropdown__hint">
                No Cmd/Ctrl needed ‚Äî just check what you want.
              </p>
            </div>
          </div>
        </div>

        <div class="filter-row filter-row--actions">
          <button type="button" class="btn-reset-all" id="reset-all">Clear all filters</button>
        </div>
      </div>
    </section>

    <!-- ‚úÖ Selected summary bar -->
    <div id="selected-bar" class="selected-bar" style="display:none;">
      <div class="selected-bar__left">
        <span class="selected-bar__title">
          Selected: <strong id="selected-count">0</strong>
        </span>
        <div class="selected-bar__pills" id="selected-pills"></div>
      </div>

      <div class="selected-bar__right">
        <button type="button" class="selected-bar__btn" id="selected-clear">Clear</button>
        <button type="button" class="selected-bar__btn selected-bar__btn--primary" id="selected-view">
          View results (<span id="selected-visible">0</span>)
        </button>
      </div>
    </div>

    <section class="neighborhoods">
      <div class="neighborhoods__grid" id="neighborhood-grid">
        {neighborhoods.map((n) => (
          <a
            class="neighborhood-card"
            href={`/neighborhood/${n.slug}`}
            data-slug={n.slug}
            data-name={n.name.toLowerCase()}
            data-count={n.count}
          >
            <div class="neighborhood-card__name">{n.name}</div>
            <div class="neighborhood-card__meta">
              {n.slug === "mobile"
                ? "Mobile & pop-up"
                : `${n.count} listing${n.count === 1 ? "" : "s"}`}
            </div>
          </a>
        ))}
      </div>

      <div id="empty-state" class="empty-state" style="display:none;">
        <div class="empty-state__icon">üîç</div>
        <h3 class="empty-state__title">No neighborhoods found</h3>
        <p class="empty-state__message">Try adjusting your search or selections.</p>
        <button id="reset-from-empty" class="empty-state__button">Clear all filters</button>
      </div>
    </section>
  </div>

  <!-- ‚úÖ Floating mobile CTA -->
  <button id="mobile-view-results" class="mobile-view-results" type="button" style="display:none;">
    View <span id="mobile-view-results-count">0</span> results
  </button>

  <style>
    .directory { display: flex; flex-direction: column; gap: 1.5rem; }

    .directory__breadcrumb {
      display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;
      color: var(--text-muted); margin-bottom: 0.25rem; flex-wrap: wrap;
    }
    .directory__breadcrumb-link { text-decoration: none; color: inherit; }
    .directory__breadcrumb-link:hover { text-decoration: underline; }
    .directory__breadcrumb-current { font-weight: 600; }

    .directory__title { margin: 0; font-size: 1.6rem; line-height: 1.2; }
    .directory__subtitle { margin: 0.35rem 0 0; font-size: 0.9rem; color: var(--text-muted); max-width: 42rem; }

    .filter-panel {
      border-radius: 0.9rem; border: 1px solid var(--border-subtle);
      background: var(--bg-elevated); box-shadow: var(--shadow-soft);
      padding: 0.9rem 1rem 1rem; display: flex; flex-direction: column; gap: 0.75rem;
    }

    /* ‚úÖ Mobile filter toggle */
    .filter-panel__toggle {
      display: none;
      width: 100%;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-main);
      gap: 0.75rem;
    }

    .filter-badge {
      background: var(--accent);
      color: white;
      padding: 0.15rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 600;
      min-width: 1.5rem;
      text-align: center;
    }

    .filter-toggle__icon { font-size: 0.75rem; transition: transform 0.2s; }
    .filter-panel[data-collapsed="false"] .filter-toggle__icon { transform: rotate(180deg); }

    @media (max-width: 768px) {
      .filter-panel__toggle { display: flex; }
      .filter-panel[data-collapsed="true"] .filter-panel__content { display: none; }
      .filter-panel { padding: 0; }
      .filter-panel__content { padding: 0.9rem 1rem 1rem; }
    }

    .filter-row { display: flex; flex-wrap: wrap; gap: 0.4rem 0.6rem; align-items: flex-start; }
    .filter-row--top { align-items: flex-end; gap: 0.75rem; flex-wrap: wrap; }
    .filter-row--actions { justify-content: flex-end; padding-top: 0.5rem; border-top: 1px solid var(--border-subtle); }

    .filter-search-wrap { flex: 1 1 220px; min-width: 0; }
    .filter-sort-wrap { flex: 0 0 auto; min-width: 160px; }

    .filter-label {
      display: block; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.05em;
      text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.15rem;
    }

    .filter-search { position: relative; display: flex; align-items: center; }
    .filter-search__icon { position: absolute; left: 0.75rem; color: var(--text-muted); pointer-events: none; opacity: 0.7; }
    .filter-search__input {
      width: 100%; border-radius: 9999px; border: 1px solid var(--border-subtle);
      background: var(--bg-page); padding: 0.4rem 2rem 0.4rem 2.5rem; font-size: 0.85rem;
    }
    .filter-search__clear {
      position: absolute; right: 0.4rem; border: none; background: transparent; font-size: 0.8rem;
      cursor: pointer; color: var(--text-muted); padding: 0.1rem; opacity: 0; pointer-events: none;
      transition: opacity 0.15s;
    }
    .filter-search__clear.is-visible { opacity: 1; pointer-events: auto; }

    .filter-sort {
      width: 100%; border-radius: 9999px; border: 1px solid var(--border-subtle);
      background: var(--bg-page); padding: 0.35rem 0.75rem; font-size: 0.8rem;
    }

    .btn-reset-all {
      padding: 0.4rem 1rem; border-radius: 9999px; border: 1px solid var(--border-subtle);
      background: transparent; font-size: 0.8rem; color: var(--text-muted);
      cursor: pointer; transition: all 0.15s;
    }

    .filter-dropdowns { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; margin-top: 0.5rem; }

    .multi-check { border: 1px solid var(--border-subtle); background: var(--bg-page); border-radius: 0.5rem; padding: 0.5rem; }
    .multi-check__actions { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
    .multi-check__btn { border: 1px solid var(--border-subtle); background: var(--bg-elevated); color: var(--text-main); border-radius: 9999px; padding: 0.25rem 0.6rem; font-size: 0.75rem; cursor: pointer; }
    .multi-check__list { max-height: 220px; overflow: auto; display: flex; flex-direction: column; gap: 0.25rem; padding-right: 0.25rem; }

    .multi-check__item { display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.4rem; border-radius: 0.4rem; cursor: pointer; user-select: none; }
    .multi-check__item:focus-within { background: var(--accent-soft); outline: 1px solid var(--border-subtle); }

    .multi-check__box { width: 16px; height: 16px; accent-color: var(--accent); }
    .multi-check__text { font-size: 0.85rem; display: inline-flex; gap: 0.25rem; align-items: baseline; flex-wrap: wrap; }
    .multi-check__muted { font-size: 0.75rem; color: var(--text-muted); }

    .neighborhoods__grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 0.9rem; }
    .neighborhood-card {
      display: block; text-decoration: none; color: inherit;
      border-radius: 0.9rem; border: 1px solid var(--border-subtle);
      background: var(--bg-elevated); box-shadow: var(--shadow-soft);
      padding: 1rem 1.1rem; transition: transform 0.15s, border-color 0.15s;
    }
    .neighborhood-card:hover { transform: translateY(-2px); border-color: var(--accent); }
    .neighborhood-card__name { font-weight: 700; font-size: 1rem; margin: 0 0 0.25rem; }
    .neighborhood-card__meta { font-size: 0.8rem; color: var(--text-muted); }

    .empty-state {
      text-align: center; padding: 3rem 1rem;
      border: 1px solid var(--border-subtle); border-radius: 0.9rem; background: var(--bg-elevated);
      margin-top: 1rem;
    }
    .empty-state__icon { font-size: 1.6rem; margin-bottom: 0.5rem; }
    .empty-state__title { margin: 0; font-size: 1rem; }
    .empty-state__message { margin: 0.35rem 0 0.75rem; font-size: 0.85rem; color: var(--text-muted); }
    .empty-state__button { border: 1px solid var(--border-subtle); background: transparent; color: var(--text-muted); border-radius: 9999px; padding: 0.4rem 1rem; cursor: pointer; }

    /* ‚úÖ Selected summary bar */
    .selected-bar {
      position: sticky;
      top: 0.75rem;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.65rem 0.85rem;
      border-radius: 0.9rem;
      border: 1px solid var(--border-subtle);
      background: var(--bg-elevated);
      box-shadow: var(--shadow-soft);
    }
    .selected-bar__left { display: flex; gap: 0.75rem; align-items: center; min-width: 0; }
    .selected-bar__title { font-size: 0.85rem; color: var(--text-main); white-space: nowrap; }

    .selected-bar__pills { display: flex; gap: 0.35rem; flex-wrap: wrap; min-width: 0; }

    .selected-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.55rem;
      border-radius: 9999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-page);
      font-size: 0.75rem;
      color: var(--text-main);
      max-width: 260px;
    }
    .selected-pill__text {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 200px;
    }
    .selected-pill__remove {
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.85rem;
      line-height: 1;
      padding: 0;
    }

    .selected-bar__right { display: flex; gap: 0.5rem; align-items: center; }
    .selected-bar__btn {
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-muted);
      border-radius: 9999px;
      padding: 0.35rem 0.7rem;
      font-size: 0.75rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .selected-bar__btn--primary { background: var(--accent); border-color: var(--accent); color: white; }

    /* ‚úÖ Floating mobile CTA */
    .mobile-view-results {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 1rem;
      z-index: 50;
      border: none;
      border-radius: 9999px;
      padding: 0.8rem 1.1rem;
      font-size: 0.9rem;
      font-weight: 700;
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-soft);
      cursor: pointer;
    }
    @media (min-width: 769px) {
      .mobile-view-results { display: none !important; }
    }
  </style>

  <script>
    const searchInput = document.getElementById("neighborhood-search");
    const clearBtn = document.getElementById("neighborhood-search-clear");
    const sortSelect = document.getElementById("sort");
    const grid = document.getElementById("neighborhood-grid");
    const visibleCount = document.getElementById("visible-count");

    // mobile collapse
    const filterPanel = document.getElementById("filters");
    const filterToggle = document.getElementById("filter-toggle");
    const filterToggleText = document.getElementById("filter-toggle-text");
    const filterCountBadge = document.getElementById("filter-count");

    const checksWrap = document.getElementById("neighborhood-checks");
    const checkboxes = Array.from(checksWrap?.querySelectorAll('input[type="checkbox"]') || []);
    const cards = Array.from(document.querySelectorAll(".neighborhood-card"));

    const selectAllBtn = document.getElementById("select-all");
    const clearAllBtn = document.getElementById("clear-all");
    const resetAllBtn = document.getElementById("reset-all");
    const emptyState = document.getElementById("empty-state");
    const resetFromEmpty = document.getElementById("reset-from-empty");

    // selected sticky bar
    const selectedBar = document.getElementById("selected-bar");
    const selectedCountEl = document.getElementById("selected-count");
    const selectedVisibleEl = document.getElementById("selected-visible");
    const selectedPills = document.getElementById("selected-pills");
    const selectedClearBtn = document.getElementById("selected-clear");
    const selectedViewBtn = document.getElementById("selected-view");

    // mobile floating CTA
    const mobileViewBtn = document.getElementById("mobile-view-results");
    const mobileViewCount = document.getElementById("mobile-view-results-count");

    function normalize(str) {
      return (str || "").toLowerCase().trim();
    }

    // match "five points" with slug "five-points"
    function qToSlug(q) {
      return normalize(q).replace(/\s+/g, "-").replace(/[^a-z0-9-]+/g, "");
    }

    function isMobile() {
      return window.matchMedia && window.matchMedia("(max-width: 768px)").matches;
    }

    function updateClearButton() {
      if (!clearBtn || !searchInput) return;
      const hasValue = !!searchInput.value.trim();
      clearBtn.classList.toggle("is-visible", hasValue);
    }

    function getSelectedSlugs() {
      const selected = checkboxes.filter((c) => c.checked).map((c) => c.value);
      return new Set(selected);
    }

    function visibleCheckboxes() {
      return checkboxes.filter((c) => {
        const row = c.closest(".multi-check__item");
        return !row || row.style.display !== "none";
      });
    }

    function getActiveFilterCount(selectedSet) {
      let count = 0;
      if (searchInput && searchInput.value.trim()) count++;
      if (selectedSet && selectedSet.size) count += selectedSet.size;
      return count;
    }

    function updateFilterBadge(selectedSet) {
      const count = getActiveFilterCount(selectedSet);
      if (!filterCountBadge) return;
      filterCountBadge.textContent = String(count);
      filterCountBadge.style.display = count > 0 ? "" : "none";
    }

    function renderSelectedBar(selectedSet, visibleResults) {
      if (!selectedBar || !selectedCountEl || !selectedPills || !selectedVisibleEl) return;

      const selectedArr = Array.from(selectedSet || []);
      const hasAny = selectedArr.length > 0;

      selectedBar.style.display = hasAny ? "flex" : "none";
      selectedCountEl.textContent = String(selectedArr.length);
      selectedVisibleEl.textContent = String(visibleResults);

      selectedPills.innerHTML = "";
      selectedArr.slice(0, 6).forEach((slug) => {
        const box = checkboxes.find((c) => c.value === slug);
        const label = box?.dataset?.label || slug;

        const pill = document.createElement("span");
        pill.className = "selected-pill";
        pill.innerHTML = `
          <span class="selected-pill__text" title="${label}">${label}</span>
          <button type="button" class="selected-pill__remove" aria-label="Remove ${label}" data-remove="${slug}">√ó</button>
        `;
        selectedPills.appendChild(pill);
      });

      if (selectedArr.length > 6) {
        const more = document.createElement("span");
        more.className = "selected-pill";
        more.innerHTML = `<span class="selected-pill__text">+${selectedArr.length - 6} more</span>`;
        selectedPills.appendChild(more);
      }

      selectedPills.querySelectorAll("[data-remove]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const slug = btn.dataset.remove;
          const box = checkboxes.find((c) => c.value === slug);
          if (box) box.checked = false;
          applyFilters({ userInitiated: true });
        });
      });
    }

    function showMobileViewCTA(visibleResults, shouldShow) {
      if (!mobileViewBtn || !mobileViewCount) return;

      if (!isMobile()) {
        mobileViewBtn.style.display = "none";
        return;
      }

      mobileViewCount.textContent = String(visibleResults);
      mobileViewBtn.style.display = shouldShow ? "block" : "none";
    }

    function scrollToGrid() {
      const section = document.querySelector(".neighborhoods");
      if (section) section.scrollIntoView({ behavior: "smooth", block: "start" });
      else if (grid) grid.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function applyFilters(opts = {}) {
      const userInitiated = !!opts.userInitiated;

      const qRaw = searchInput?.value || "";
      const q = normalize(qRaw);
      const qSlug = qToSlug(qRaw);

      const selected = getSelectedSlugs();
      const sortMode = sortSelect?.value || "count";

      // filter checkbox list by search text
      checkboxes.forEach((box) => {
        const row = box.closest(".multi-check__item");
        if (!row) return;
        const name = box.dataset.name || "";
        const slug = box.value || "";
        const show = !q || name.includes(q) || slug.includes(qSlug);
        row.style.display = show ? "" : "none";
      });

      // filter cards
      let visible = 0;
      const visibleCards = [];

      cards.forEach((card) => {
        const name = card.dataset.name || "";
        const slug = card.dataset.slug || "";
        const count = Number(card.dataset.count || "0");

        const matchesText = !q || name.includes(q) || slug.includes(qSlug);
        const matchesSelected = selected.size === 0 || selected.has(slug);

        const show = matchesText && matchesSelected;
        card.style.display = show ? "" : "none";

        if (show) {
          visible++;
          visibleCards.push({ card, name, count });
        }
      });

      // sort visible cards
      visibleCards.sort((a, b) => {
        if (sortMode === "az") return a.name.localeCompare(b.name);
        return b.count - a.count || a.name.localeCompare(b.name);
      });

      if (grid) visibleCards.forEach((x) => grid.appendChild(x.card));
      if (visibleCount) visibleCount.textContent = String(visible);

      if (emptyState) emptyState.style.display = visible === 0 ? "block" : "none";
      if (grid) grid.style.display = visible === 0 ? "none" : "";

      updateClearButton();
      updateFilterBadge(selected);
      renderSelectedBar(selected, visible);

      // show mobile CTA when user changes filters
      const shouldShowCTA = userInitiated && isMobile() && visible > 0;
      showMobileViewCTA(visible, shouldShowCTA);

      // collapse filters on mobile after a change (keeps focus on results)
      if (userInitiated && isMobile() && filterPanel && filterPanel.dataset) {
        if (visible > 0) {
          filterPanel.dataset.collapsed = "true";
          if (filterToggleText) filterToggleText.textContent = "Show Filters";
        }
      }
    }

    function resetAll() {
      if (searchInput) searchInput.value = "";
      checkboxes.forEach((c) => (c.checked = false));
      if (sortSelect) sortSelect.value = "count";
      applyFilters({ userInitiated: true });
    }

    // filter toggle
    if (filterToggle && filterPanel && filterToggleText) {
      filterToggle.addEventListener("click", () => {
        const isCollapsed = filterPanel.dataset.collapsed === "true";
        filterPanel.dataset.collapsed = isCollapsed ? "false" : "true";
        filterToggleText.textContent = isCollapsed ? "Hide Filters" : "Show Filters";
      });
    }

    // events
    searchInput?.addEventListener("input", () => applyFilters({ userInitiated: true }));

    clearBtn?.addEventListener("click", () => {
      if (!searchInput) return;
      searchInput.value = "";
      searchInput.focus();
      applyFilters({ userInitiated: true });
    });

    sortSelect?.addEventListener("change", () => applyFilters({ userInitiated: true }));
    checkboxes.forEach((c) => c.addEventListener("change", () => applyFilters({ userInitiated: true })));

    selectAllBtn?.addEventListener("click", () => {
      visibleCheckboxes().forEach((c) => (c.checked = true));
      applyFilters({ userInitiated: true });
    });

    clearAllBtn?.addEventListener("click", () => {
      visibleCheckboxes().forEach((c) => (c.checked = false));
      applyFilters({ userInitiated: true });
    });

    resetAllBtn?.addEventListener("click", resetAll);
    resetFromEmpty?.addEventListener("click", resetAll);

    selectedClearBtn?.addEventListener("click", () => {
      checkboxes.forEach((c) => (c.checked = false));
      applyFilters({ userInitiated: true });
    });

    selectedViewBtn?.addEventListener("click", () => {
      scrollToGrid();
      showMobileViewCTA(Number(visibleCount?.textContent || "0"), false);
    });

    mobileViewBtn?.addEventListener("click", () => {
      scrollToGrid();
      mobileViewBtn.style.display = "none";
    });

    // initial
    updateClearButton();
    if (filterPanel && filterPanel.dataset && isMobile()) {
      filterPanel.dataset.collapsed = "true";
      if (filterToggleText) filterToggleText.textContent = "Show Filters";
    }
    applyFilters({ userInitiated: false });
  </script>
</BaseLayout>
