---
import BaseLayout from "../../layouts/Base.astro";
import { businesses } from "../../lib/businesses";
import { slugForType, slugForNeighborhood } from "../../lib/slugs.js";

/** Helper to create URL-friendly slugs */
function slugForType(t: string): string {
  if (!t) return "other";
  return (
    String(t)
      .toLowerCase()
      .trim()
      .replace(/&/g, "and")
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "") || "other"
  );
}

function slugForNeighborhood(n: string): string {
  return String(n || "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

// Normalize function for deduplication (case-insensitive, trim whitespace)
function normalizeTypeValue(val: string): string {
  return (val || "").toLowerCase().trim();
}

// Extract individual tags from a cuisine type (e.g., "Coffee, Tea & Wine" -> ["coffee", "tea", "wine"])
function extractTags(typeString: string): Set<string> {
  return new Set(
    (typeString || "")
      .toLowerCase()
      .split(/[,&]/) // Split by comma or ampersand
      .map((tag) => tag.trim())
      .filter((tag) => tag.length > 0)
  );
}

// Convert a business's types into a flat set of all unique tags
function getBusinessTags(types: string[]): Set<string> {
  const allTags = new Set<string>();
  (types || []).forEach((type) => {
    extractTags(type).forEach((tag) => allTags.add(tag));
  });
  return allTags;
}

// Helper function for amenity icons
function getAmenityIcon(tag: string): string {
  const icons: Record<string, string> = {
    takeout: "ü•°",
    "dine-in": "üçΩÔ∏è",
    "outdoor seating": "üå≥",
    delivery: "üöö",
    "vegan options": "üå±",
    "live entertainment": "üéµ",
    "lgbtq+ friendly": "üè≥Ô∏è‚Äçüåà",
    "wine and beer": "üç∑",
    "parking available": "üÖøÔ∏è",
    "pet-friendly patio": "üêæ",
    "live music": "üé∏",
    "free admission": "üéüÔ∏è",
    "artist talks": "üé®",
    "workshop space": "üõ†Ô∏è",
  };
  return icons[String(tag || "").toLowerCase()] || "‚úì";
}

// üî• Tell Astro which /type/[type]/ pages to generate
export function getStaticPaths() {
  const enhanced = businesses.map((b) => ({
    ...b,
    primaryType:
      b.type ||
      (Array.isArray(b.businessCategories) && b.businessCategories[0]) ||
      "Other",
  }));

  const allTypeLabels = Array.from(new Set(enhanced.map((b) => b.primaryType))).filter(Boolean);

  const slugToLabel = new Map<string, string>();
  for (const label of allTypeLabels) {
    const slug = slugForType(label); // ‚úÖ now defined
    if (!slugToLabel.has(slug)) slugToLabel.set(slug, label);
  }

  return Array.from(slugToLabel.keys()).map((slug) => ({
    params: { type: slug },
  }));
}

// Get the URL parameter
const { type } = Astro.params;
const typeParam = type ?? "";

// Enhance businesses with primaryType
const enhanced = businesses.map((b) => ({
  ...b,
  primaryType:
    b.type ||
    (Array.isArray(b.businessCategories) && b.businessCategories[0]) ||
    "Other",
}));

// Filter businesses that match this type slug
const filtered = enhanced.filter((b) => slugForType(b.primaryType) === typeParam);

if (!filtered.length) {
  return Astro.redirect("/");
}

// Use the first item to display a human label
const currentTypeLabel = filtered[0].primaryType;
const typeSlug = slugForType(currentTypeLabel);

// Detect the type
const isEntertainment = typeSlug === "entertainment";
const isArt = typeSlug === "art";

// Build filter lists from this type only
const allNeighborhoods = Array.from(new Set(filtered.flatMap((b) => b.neighborhoods || []))).sort();

// Use appropriate field based on type with deduplication
let primaryTypes: string[] = [];
let primaryTypeMap = new Map<string, string>(); // maps normalized -> original for display

if (isEntertainment) {
  const raw = filtered.flatMap((b) => b.entertainmentTypes || []);
  raw.forEach((type) => {
    const norm = normalizeTypeValue(type);
    if (!primaryTypeMap.has(norm)) {
      primaryTypeMap.set(norm, type); // Keep first occurrence
    }
  });
  primaryTypes = Array.from(primaryTypeMap.values()).sort();
} else if (isArt) {
  const raw = filtered.flatMap((b) => b.artTypes || []);
  raw.forEach((type) => {
    const norm = normalizeTypeValue(type);
    if (!primaryTypeMap.has(norm)) {
      primaryTypeMap.set(norm, type);
    }
  });
  primaryTypes = Array.from(primaryTypeMap.values()).sort();
} else {
  const raw = filtered.flatMap((b) => b.cuisineTypes || []);
  raw.forEach((type) => {
    const norm = normalizeTypeValue(type);
    if (!primaryTypeMap.has(norm)) {
      primaryTypeMap.set(norm, type);
    }
  });
  primaryTypes = Array.from(primaryTypeMap.values()).sort();
}

const allMicrofilters = Array.from(new Set(filtered.flatMap((b) => b.microfilters || []))).sort();

// Customize label based on type
let primaryFacetLabel = "Cuisine";
if (isEntertainment) primaryFacetLabel = "Entertainment Type";
if (isArt) primaryFacetLabel = "Art Type";

// Customize search placeholder
let searchPlaceholder = "Try: soul food, brunch, Park Hill";
if (isEntertainment) searchPlaceholder = "Try: jazz, live music, Five Points, LGBTQ+ friendly";
if (isArt) searchPlaceholder = "Try: contemporary, sculpture, downtown, free admission";

// Prepare location data for the map
const locationsForMap = filtered
  .filter((b) => b.latitude && b.longitude)
  .map((b) => ({
    slug: b.slug,
    name: b.name,
    lat: b.latitude,
    lng: b.longitude,
    neighborhoods: b.neighborhoods || [],
    type: b.primaryType,
  }));

const displayTypeLabel = currentTypeLabel.charAt(0).toUpperCase() + currentTypeLabel.slice(1);

/* --------------------------
   SEO / JSON-LD
   (PASS via BaseLayout props ‚Äî no inline JSON.stringify here)
--------------------------- */
const pageTitle = `${displayTypeLabel} ‚Ä¢ Local Business Directory`;
const pageDescription = `Explore Black-owned ${currentTypeLabel.toLowerCase()} businesses in the Denver metro area. Filter by neighborhood${
  primaryTypes.length ? `, ${primaryFacetLabel.toLowerCase()}` : ""
}, and amenities.`;
const pageImage = "/og-denver-black-guide.png";

const origin =
  import.meta.env.SITE_URL ||
  Astro.url.origin ||
  Astro.site;

const canonical = new URL(Astro.url.pathname, origin).toString();
const absoluteImage = new URL(pageImage, origin).toString();

const listItems = filtered.slice(0, 100).map((b, i) => ({
  "@type": "ListItem",
  position: i + 1,
  name: b.name,
  url: new URL(`/business/${b.slug}`, origin).toString(),
}));

const jsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      name: "Denver Black Guide",
      url: new URL("/", origin).toString(),
      logo: absoluteImage,
    },
    {
      "@type": "WebPage",
      name: pageTitle,
      url: canonical,
      description: pageDescription,
      primaryImageOfPage: {
        "@type": "ImageObject",
        url: absoluteImage,
      },
      breadcrumb: {
        "@type": "BreadcrumbList",
        itemListElement: [
          {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: new URL("/", origin).toString(),
          },
          {
            "@type": "ListItem",
            position: 2,
            name: displayTypeLabel,
            item: canonical,
          },
        ],
      },
    },
    {
      "@type": "ItemList",
      name: `${displayTypeLabel} businesses in Denver`,
      itemListOrder: "https://schema.org/ItemListOrderAscending",
      numberOfItems: filtered.length,
      itemListElement: listItems,
    },
  ],
};
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  image={pageImage}
  canonical={canonical}
  jsonLd={jsonLd}
>
  <!-- Optional extra SEO head bits (no JSON-LD here) -->
  <Fragment slot="head">
    <meta name="author" content="Denver Black Guide" />
    <meta property="og:site_name" content="Denver Black Guide" />
    <meta property="og:locale" content="en_US" />
    <meta
      property="og:image:alt"
      content={`Denver Black Guide ${displayTypeLabel} directory preview`}
    />
    <meta
      name="twitter:image:alt"
      content={`Denver Black Guide ${displayTypeLabel} directory preview`}
    />
  </Fragment>

  <div class="directory">
    <!-- Breadcrumb -->
    <nav aria-label="Breadcrumb" class="directory__breadcrumb">
      <a href="/" class="directory__breadcrumb-link">Home</a>
      <span aria-hidden="true">/</span>
      <span class="directory__breadcrumb-current">{displayTypeLabel}</span>
    </nav>

    <header class="directory__head">
      <h1 class="directory__title">{displayTypeLabel}</h1>
      <p class="directory__subtitle">
        Explore {currentTypeLabel.toLowerCase()} ‚Äî filter by neighborhood,
        {primaryTypes.length ? ` ${primaryFacetLabel.toLowerCase()},` : ""} and
        amenities.
      </p>
    </header>

    <!-- FILTERS -->
    <section
      class="filter-panel"
      id="filters"
      aria-label={`${currentTypeLabel} filters`}
      data-collapsed="true"
    >
      <!-- Mobile filter toggle -->
      <button class="filter-panel__toggle" id="filter-toggle" type="button">
        <span id="filter-toggle-text">Show Filters</span>
        <span class="filter-badge" id="filter-count">0</span>
        <span class="filter-toggle__icon">‚ñº</span>
      </button>

      <div class="filter-panel__content">
        <!-- Top row: search + sort -->
        <div class="filter-row filter-row--top">
          <div class="filter-search-wrap">
            <label for="search" class="filter-label">Search</label>
            <div class="filter-search">
              <svg
                class="filter-search__icon"
                width="16"
                height="16"
                viewBox="0 0 16 16"
                fill="none"
              >
                <path
                  d="M7 13A6 6 0 1 0 7 1a6 6 0 0 0 0 12zM14 14l-3-3"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                />
              </svg>
              <input
                id="search"
                name="directory-search"
                type="search"
                class="filter-search__input"
                placeholder={searchPlaceholder}
                autocomplete="off"
                autocapitalize="none"
                spellcheck="false"
              />
              <button
                type="button"
                id="search-clear"
                class="filter-search__clear"
                aria-label="Clear search"
              >
                ‚úï
              </button>
            </div>
          </div>

          <div class="filter-sort-wrap">
            <label for="sort" class="filter-label">Sort by</label>
            <select id="sort" class="filter-sort">
              <option value="az">A‚ÄìZ (Name)</option>
              <option value="neighborhood">Neighborhood</option>
            </select>
          </div>
        </div>

        <!-- Filter dropdowns -->
        <div class="filter-dropdowns">
          {allNeighborhoods.length > 0 && (
            <div class="filter-dropdown">
              <label for="neighborhood-select" class="filter-label">
                Neighborhood
              </label>
              <select id="neighborhood-select" class="filter-select">
                <option value="">All Neighborhoods</option>
                {allNeighborhoods.map((n) => (
                  <option value={n.toLowerCase()}>{n}</option>
                ))}
              </select>
            </div>
          )}

          {primaryTypes.length > 0 && (
            <div class="filter-dropdown">
              <label for="primary-select" class="filter-label">
                {primaryFacetLabel}
              </label>
              <select id="primary-select" class="filter-select" multiple size="4">
                {primaryTypes.map((c) => (
                  <option value={normalizeTypeValue(c)}>{c}</option>
                ))}
              </select>
              <p class="filter-dropdown__hint">Hold Ctrl/Cmd to select multiple</p>
            </div>
          )}

          {allMicrofilters.length > 0 && (
            <div class="filter-dropdown">
              <label for="amenities-select" class="filter-label">
                Amenities &amp; Options
              </label>
              <select id="amenities-select" class="filter-select" multiple size="4">
                {allMicrofilters.map((m) => (
                  <option value={m.toLowerCase()}>{m}</option>
                ))}
              </select>
              <p class="filter-dropdown__hint">Hold Ctrl/Cmd to select multiple</p>
            </div>
          )}
        </div>

        <div class="filter-row filter-row--actions">
          <button type="button" id="reset-all-filters" class="btn-reset-all">
            Clear all filters
          </button>
        </div>
      </div>
    </section>

    <!-- Active filters summary -->
    <div id="active-filters-summary" class="active-filters" style="display: none;">
      <span class="active-filters__label">Active:</span>
      <div id="active-filters-list" class="active-filters__list"></div>
    </div>

    <!-- Map Toggle for Mobile -->
    <button class="map-toggle" id="map-toggle" type="button">
      <span id="map-toggle-text">üìç Show Map</span>
    </button>

    <!-- Split View -->
    <div class="split-container" id="split-container">
      <!-- Map -->
      <section class="map-section" id="map-section" aria-label="Map view">
        <div id="map" class="map-view"></div>
        <div class="map-overlay">
          <p class="map-overlay__text">
            <span id="map-marker-count">{locationsForMap.length}</span> locations
          </p>
        </div>
      </section>

      <!-- Results -->
      <section aria-label={`${currentTypeLabel} results`} class="directory__results">
        <p id="results-count" class="directory__results-count">
          Showing {filtered.length} place{filtered.length === 1 ? "" : "s"}
        </p>

        <div id="empty-state" class="empty-state" style="display: none;">
          <div class="empty-state__icon">üîç</div>
          <h3 class="empty-state__title">No businesses found</h3>
          <p class="empty-state__message">Try adjusting your filters or search terms</p>
          <button id="reset-from-empty" class="empty-state__button">Clear all filters</button>
        </div>

        <div id="results-grid" class="directory__grid">
          {filtered.map((b) => {
            const name = b.name || "";
            const cuisines = b.cuisineTypes || [];
            const entertainmentTypes = b.entertainmentTypes || [];
            const artTypes = b.artTypes || [];
            const neighborhoods = b.neighborhoods || [];
            const microfilters = b.microfilters || [];

            let displayTypes: string[] = [];
            if (isEntertainment) displayTypes = entertainmentTypes;
            else if (isArt) displayTypes = artTypes;
            else displayTypes = cuisines;

            // Extract all individual tags from cuisine/type strings for smart matching
            // e.g., "Coffee & Tea" becomes "coffee|tea", "Beer, Wine" becomes "beer|wine"
            const businessTags = getBusinessTags(displayTypes);
            const tagsForMatching = Array.from(businessTags).join("|");

            return (
              <a
                href={`/business/${b.slug}`}
                class="business-card-link"
                data-slug={b.slug}
                data-name={name.toLowerCase()}
                data-primary-types={tagsForMatching}
                data-neighborhoods={neighborhoods.join("|").toLowerCase()}
                data-microfilters={microfilters.join("|").toLowerCase()}
                data-lat={b.latitude}
                data-lng={b.longitude}
              >
                <article class="card business-card">
                  <h2 class="business-card__name">{name}</h2>

                  <div class="business-card__quick-info">
                    <span class="quick-info-item">
                      <span class="quick-info-item__icon">üìç</span>

                      {neighborhoods.length > 0 ? (
                        <span class="neighborhood-chip-row">
                          {neighborhoods.slice(0, 2).map((n) => (
                            <button
                              type="button"
                              class="neighborhood-chip"
                              data-neighborhood-slug={slugForNeighborhood(n)}
                              aria-label={`View businesses in ${n}`}
                            >
                              {n}
                            </button>
                          ))}
                          {neighborhoods.length > 2 && (
                            <span class="neighborhood-more">
                              +{neighborhoods.length - 2}
                            </span>
                          )}
                        </span>
                      ) : (
                        <span>{"Location TBD"}</span>
                      )}
                    </span>

                    {b.yearEstablished && (
                      <span class="quick-info-item">
                        <span class="quick-info-item__icon">üìÖ</span>
                        Est. {b.yearEstablished}
                      </span>
                    )}
                  </div>

                  <p class="business-card__meta">
                    {displayTypes.length > 0 ? (
                      <>
                        <span class="business-card__type">{primaryFacetLabel}:</span>{" "}
                        <span>{displayTypes.join(", ")}</span>
                      </>
                    ) : (
                      <span class="business-card__type">{currentTypeLabel}</span>
                    )}
                  </p>

                  {microfilters.length > 0 && (
                    <div class="business-card__amenities">
                      {microfilters.slice(0, 3).map((tag) => {
                        const icon = getAmenityIcon(tag);
                        return (
                          <span class="amenity-tag" title={tag}>
                            <span class="amenity-tag__icon">{icon}</span>
                            <span class="amenity-tag__label">{tag}</span>
                          </span>
                        );
                      })}
                      {microfilters.length > 3 && (
                        <span class="business-card__more">
                          +{microfilters.length - 3} more
                        </span>
                      )}
                    </div>
                  )}

                  <div class="business-card__action">View Details ‚Üí</div>
                </article>
              </a>
            );
          })}
        </div>
      </section>
    </div>
  </div>

  <style>
    /* (Your CSS unchanged ‚Äî pasted from your current file) */
    .directory {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .directory__breadcrumb {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }
    .directory__breadcrumb-link {
      text-decoration: none;
    }
    .directory__breadcrumb-link:hover {
      text-decoration: underline;
    }
    .directory__breadcrumb-current {
      font-weight: 600;
    }

    .directory__head {
      margin-bottom: 0.25rem;
    }

    .directory__title {
      margin: 0;
      font-size: 1.6rem;
      line-height: 1.2;
    }

    .directory__subtitle {
      margin: 0.35rem 0 0;
      font-size: 0.9rem;
      color: var(--text-muted);
      max-width: 42rem;
    }

    .filter-panel {
      border-radius: 0.9rem;
      border: 1px solid var(--border-subtle);
      background: var(--bg-elevated);
      box-shadow: var(--shadow-soft);
      padding: 0.9rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .filter-panel__toggle {
      display: none;
      width: 100%;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-main);
      gap: 0.75rem;
    }

    .filter-badge {
      background: var(--accent);
      color: white;
      padding: 0.15rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.7rem;
      font-weight: 600;
      min-width: 1.5rem;
      text-align: center;
    }

    .filter-toggle__icon {
      font-size: 0.75rem;
      transition: transform 0.2s;
    }

    .filter-panel[data-collapsed="false"] .filter-toggle__icon {
      transform: rotate(180deg);
    }

    @media (max-width: 768px) {
      .filter-panel__toggle {
        display: flex;
      }

      .filter-panel[data-collapsed="true"] .filter-panel__content {
        display: none;
      }

      .filter-panel {
        padding: 0;
      }

      .filter-panel__content {
        padding: 0.9rem 1rem 1rem;
      }
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem 0.6rem;
      align-items: flex-start;
    }

    .filter-row--top {
      align-items: flex-end;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .filter-row--actions {
      justify-content: flex-end;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border-subtle);
    }

    .filter-search-wrap {
      flex: 1 1 220px;
      min-width: 0;
    }

    .filter-sort-wrap {
      flex: 0 0 auto;
      min-width: 150px;
    }

    .filter-label {
      display: block;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 0.15rem;
    }

    .filter-search {
      position: relative;
      display: flex;
      align-items: center;
    }

    .filter-search__icon {
      position: absolute;
      left: 0.75rem;
      color: var(--text-muted);
      pointer-events: none;
      opacity: 0.7;
    }

    .filter-search__input {
      width: 100%;
      border-radius: 9999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-page);
      padding: 0.4rem 2rem 0.4rem 2.5rem;
      font-size: 0.85rem;
    }

    .filter-search__input:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 1px;
    }

    .filter-search__clear {
      position: absolute;
      right: 0.4rem;
      border: none;
      background: transparent;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0.1rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s;
    }

    .filter-search__clear.is-visible {
      opacity: 1;
      pointer-events: auto;
    }

    .filter-sort {
      width: 100%;
      border-radius: 9999px;
      border: 1px solid var(--border-subtle);
      background: var(--bg-page);
      padding: 0.35rem 0.75rem;
      font-size: 0.8rem;
    }

    .filter-dropdowns {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .filter-select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border-subtle);
      background: var(--bg-page);
      font-size: 0.85rem;
      color: var(--text-main);
      cursor: pointer;
    }

    .filter-select[multiple] {
      min-height: 120px;
      padding: 0.25rem;
    }

    .filter-dropdown__hint {
      margin: 0.25rem 0 0;
      font-size: 0.65rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .btn-reset-all {
      padding: 0.4rem 1rem;
      border-radius: 9999px;
      border: 1px solid var(--border-subtle);
      background: transparent;
      font-size: 0.8rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-reset-all:hover {
      border-color: var(--accent);
      color: var(--accent-strong);
      background: var(--accent-soft);
    }

    .active-filters {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: var(--bg-elevated);
      border-radius: 0.5rem;
      border: 1px solid var(--border-subtle);
      flex-wrap: wrap;
    }

    .active-filters__label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .active-filters__list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      flex: 1;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
    }

    @keyframes pulse {
      0%,
      100% {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3), 0 0 0 0 rgba(0,0,0,0);
      }
      50% {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3), 0 0 0 8px rgba(0, 0, 0, 0.12);
      }
    }

    .map-toggle {
      display: none;
      width: 100%;
      padding: 0.75rem 1.25rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .map-toggle:hover {
      background: var(--accent-strong);
      transform: translateY(-1px);
    }

    @media (max-width: 768px) {
      .map-toggle {
        display: block;
      }
    }

    .split-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      align-items: start;
    }

    @media (max-width: 768px) {
      .split-container {
        grid-template-columns: 1fr;
      }

      .map-section {
        display: none;
      }

      .map-section.is-visible {
        display: block;
        margin-bottom: 1rem;
      }
    }

    .map-section {
      position: sticky;
      top: 1rem;
      height: calc(100vh - 2rem);
      min-height: 500px;
      border-radius: 1rem;
      overflow: hidden;
      border: 1px solid var(--border-subtle);
      background: var(--bg-elevated);
    }

    @media (max-width: 768px) {
      .map-section {
        position: relative;
        top: 0;
        height: 450px;
        min-height: 400px;
      }
    }

    .map-view {
      width: 100%;
      height: 100%;
    }

    .map-overlay {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 1000;
    }

    .directory__results {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      min-width: 0;
    }

    .directory__results-count {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .directory__grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 0.9rem;
    }

    .business-card-link {
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .business-card {
      padding: 1rem 1.1rem 1.1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      position: relative;
      transition: transform 0.15s, box-shadow 0.15s;
      height: 100%;
    }

    .business-card-link:hover .business-card {
      transform: translateY(-2px);
      box-shadow: var(--shadow-soft);
    }

    .business-card.is-highlighted {
      border-color: var(--accent);
      background: var(--accent-soft);
      transform: translateY(-2px);
      box-shadow: var(--shadow-soft);
    }

    .business-card__name {
      margin: 0 0 0.1rem;
      font-size: 1rem;
      color: var(--text-main);
    }

    .quick-info-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .quick-info-item__icon {
      font-size: 0.85rem;
    }

    .business-card__meta {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .business-card__type {
      font-weight: 600;
    }

    .business-card__amenities {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.25rem;
    }

    .amenity-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.2rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 0.35rem;
      font-size: 0.7rem;
      color: var(--text-main);
    }

    .amenity-tag__icon {
      font-size: 0.85rem;
    }

    .business-card__more {
      font-size: 0.7rem;
      color: var(--text-muted);
      padding: 0.2rem 0.5rem;
    }

    .business-card__action {
      margin-top: auto;
      padding-top: 0.5rem;
      font-size: 0.8rem;
      color: var(--accent);
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .business-card:hover .business-card__action {
      opacity: 1;
    }

    .neighborhood-chip-row {
      display: inline-flex;
      gap: 0.35rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .neighborhood-chip {
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      color: var(--accent);
      font-weight: 600;
      font-size: 0.8rem;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .neighborhood-chip:hover {
      color: var(--accent-strong);
    }

    .neighborhood-chip:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
      border-radius: 0.35rem;
    }

    .neighborhood-more {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
  </style>

  <script is:inline define:vars={{ mapLocations: locationsForMap }}>
    // Initialize map on load
    window.addEventListener("load", function () {
      if (typeof window.L === "undefined") return;

      const markerCountEl = document.getElementById("map-marker-count");
      const mapSection = document.getElementById("map-section");
      const mapToggle = document.getElementById("map-toggle");
      const mapToggleText = document.getElementById("map-toggle-text");

      const map = window.L.map("map").setView([39.7392, -104.9903], 12);
      window.L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
        { maxZoom: 19 }
      ).addTo(map);

      const customIcon = window.L.divIcon({
        className: "custom-marker",
        html: '<div style="background: var(--accent); width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
        iconSize: [24, 24],
        iconAnchor: [12, 12],
      });

      const markers = {};
      const markerGroup = window.L.featureGroup().addTo(map);

      (mapLocations || []).forEach((location) => {
        if (!location.lat || !location.lng) return;

        const marker = window.L.marker([location.lat, location.lng], { icon: customIcon }).addTo(markerGroup);

        marker.bindPopup(`
          <div style="padding: 0.5rem;">
            <h3 style="margin: 0 0 0.25rem; font-size: 0.95rem;">
              <a href="/business/${location.slug}" style="color: var(--accent); text-decoration: none;">
                ${location.name}
              </a>
            </h3>
            <p style="margin: 0; font-size: 0.75rem; color: var(--text-muted);">
              ${
                (location.neighborhoods && location.neighborhoods.length > 0)
                  ? location.neighborhoods[0]
                  : "Denver"
              }
            </p>
          </div>
        `);

        markers[location.slug] = marker;

        marker.on("click", () => {
          const cardLink = document.querySelector(`.business-card-link[data-slug="${location.slug}"]`);
          if (cardLink) {
            cardLink.scrollIntoView({ behavior: "smooth", block: "center" });
            const card = cardLink.querySelector(".business-card");
            if (card) {
              card.classList.add("is-highlighted");
              setTimeout(() => card.classList.remove("is-highlighted"), 2000);
            }
          }
        });
      });

      if (markerGroup.getBounds().isValid()) {
        map.fitBounds(markerGroup.getBounds(), { padding: [50, 50] });
      }

      function updateMarkerCount() {
        const visibleCardLinks = document.querySelectorAll(
          '.business-card-link:not([style*="display: none"])'
        );
        const visibleSlugs = Array.from(visibleCardLinks).map((c) => c.dataset.slug);

        let visibleCount = 0;
        Object.entries(markers).forEach(([slug, marker]) => {
          if (visibleSlugs.includes(slug)) {
            markerGroup.addLayer(marker);
            visibleCount++;
          } else {
            markerGroup.removeLayer(marker);
          }
        });

        if (markerCountEl) markerCountEl.textContent = String(visibleCount);

        if (markerGroup.getBounds().isValid()) {
          map.fitBounds(markerGroup.getBounds(), { padding: [50, 50] });
        }
      }

      // Card hover highlights marker
      document.querySelectorAll(".business-card-link").forEach((cardLink) => {
        const slug = cardLink.dataset.slug;
        if (!slug) return;

        function setPulse(on) {
          const marker = markers[slug];
          if (!marker) return;
          setTimeout(() => {
            const markerEl = marker.getElement?.();
            if (!markerEl) return;
            const dot = markerEl.querySelector("div");
            if (!dot) return;

            if (on) {
              dot.style.animation = "pulse 1s ease-in-out infinite";
              dot.style.transform = "scale(1.5)";
              dot.style.transition = "transform 0.2s ease";
              markerEl.style.zIndex = "1000";
            } else {
              dot.style.animation = "";
              dot.style.transform = "scale(1)";
              markerEl.style.zIndex = "";
            }
          }, 10);
        }

        cardLink.addEventListener("mouseenter", () => setPulse(true));
        cardLink.addEventListener("mouseleave", () => setPulse(false));
        cardLink.addEventListener("focus", () => setPulse(true));
        cardLink.addEventListener("blur", () => setPulse(false));
      });

      // Mobile toggle
      if (mapToggle && mapSection && mapToggleText) {
        mapToggle.addEventListener("click", () => {
          const isVisible = mapSection.classList.contains("is-visible");
          if (isVisible) {
            mapSection.classList.remove("is-visible");
            mapToggleText.textContent = "üìç Show Map";
          } else {
            mapSection.classList.add("is-visible");
            mapToggleText.textContent = "üìç Hide Map";
            setTimeout(() => map.invalidateSize(), 100);
          }
        });
      }

      window.updateMapMarkers = updateMarkerCount;
      updateMarkerCount();
    });

    // ‚úÖ Make neighborhood names clickable inside a card-link (no nested <a>)
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".neighborhood-chip");
      if (!btn) return;

      e.preventDefault();
      e.stopPropagation();

      const slug = btn.dataset.neighborhoodSlug;
      if (!slug) return;

      window.location.href = `/neighborhood/${slug}`;
    });

    // keyboard support (Enter/Space)
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Enter" && e.key !== " ") return;

      const btn = document.activeElement?.closest?.(".neighborhood-chip");
      if (!btn) return;

      e.preventDefault();
      e.stopPropagation();

      const slug = btn.dataset.neighborhoodSlug;
      if (!slug) return;

      window.location.href = `/neighborhood/${slug}`;
    });
  </script>

  <script>
    // Normalization function (must match backend)
    function normalizeTypeValue(val) {
      return (val || "").toLowerCase().trim();
    }

    // Extract individual tags from a type string (e.g., "Coffee, Tea & Wine" -> ["coffee", "tea", "wine"])
    function extractTagsFromString(typeString) {
      return (typeString || "")
        .toLowerCase()
        .split(/[,&]/)
        .map((tag) => tag.trim())
        .filter((tag) => tag.length > 0);
    }

    // Parse the pipe-separated tags from data attribute
    function getTagsFromAttribute(attrValue) {
      return (attrValue || "")
        .split("|")
        .map((tag) => tag.trim())
        .filter((tag) => tag.length > 0);
    }

    // Check if business tags match any selected filters
    function businessMatchesPrimaryFilters(businessTagsAttr, selectedPrimaryFilters) {
      if (selectedPrimaryFilters.size === 0) return true;

      const businessTags = new Set(getTagsFromAttribute(businessTagsAttr));

      // Return true if ANY selected filter matches ANY business tag
      for (const filter of selectedPrimaryFilters) {
        if (businessTags.has(filter)) {
          return true;
        }
      }
      return false;
    }

    const searchInput = document.getElementById("search");
    const clearBtn = document.getElementById("search-clear");
    const sortSelect = document.getElementById("sort");
    const neighborhoodSelect = document.getElementById("neighborhood-select");
    const primarySelect = document.getElementById("primary-select");
    const amenitiesSelect = document.getElementById("amenities-select");
    const grid = document.getElementById("results-grid");
    const countEl = document.getElementById("results-count");
    const emptyState = document.getElementById("empty-state");
    const filterToggle = document.getElementById("filter-toggle");
    const filterToggleText = document.getElementById("filter-toggle-text");
    const filterPanel = document.getElementById("filters");
    const filterCount = document.getElementById("filter-count");
    const activeFiltersSummary = document.getElementById("active-filters-summary");
    const activeFiltersList = document.getElementById("active-filters-list");
    const resetAllBtn = document.getElementById("reset-all-filters");
    const resetFromEmpty = document.getElementById("reset-from-empty");

    const cards = Array.from(document.querySelectorAll("#results-grid .business-card-link"));

    function normalize(str) {
      return (str || "").toLowerCase().trim();
    }

    function getSelectedValues(selectElement) {
      if (!selectElement) return new Set();
      const selected = Array.from(selectElement.selectedOptions || []);
      return new Set(selected.map((opt) => normalize(opt.value)));
    }

    function updateClearButton() {
      if (!clearBtn || !searchInput) return;
      const hasValue = !!searchInput.value.trim();
      clearBtn.classList.toggle("is-visible", hasValue);
    }

    function getActiveFilterCount() {
      let count = 0;
      if (neighborhoodSelect && neighborhoodSelect.value) count++;
      if (primarySelect) count += primarySelect.selectedOptions.length;
      if (amenitiesSelect) count += amenitiesSelect.selectedOptions.length;
      if (searchInput && searchInput.value.trim()) count++;
      return count;
    }

    function updateFilterCount() {
      const count = getActiveFilterCount();
      if (filterCount) {
        filterCount.textContent = String(count);
        filterCount.style.display = count > 0 ? "" : "none";
      }
    }

    function updateActiveFiltersSummary() {
      const count = getActiveFilterCount();
      if (!activeFiltersSummary || !activeFiltersList) return;

      if (count === 0) {
        activeFiltersSummary.style.display = "none";
        activeFiltersList.innerHTML = "";
        return;
      }

      activeFiltersSummary.style.display = "flex";

      let html = "";

      if (neighborhoodSelect && neighborhoodSelect.value) {
        const label = neighborhoodSelect.options[neighborhoodSelect.selectedIndex].text;
        html += `<span class="active-filter-pill">
          üìç ${label}
          <button class="active-filter-pill__remove" data-clear="neighborhood">√ó</button>
        </span>`;
      }

      if (primarySelect) {
        Array.from(primarySelect.selectedOptions).forEach((opt) => {
          html += `<span class="active-filter-pill">
            ${opt.text}
            <button class="active-filter-pill__remove" data-clear="primary" data-value="${opt.value}">√ó</button>
          </span>`;
        });
      }

      if (amenitiesSelect) {
        Array.from(amenitiesSelect.selectedOptions).forEach((opt) => {
          html += `<span class="active-filter-pill">
            ${opt.text}
            <button class="active-filter-pill__remove" data-clear="amenity" data-value="${opt.value}">√ó</button>
          </span>`;
        });
      }

      activeFiltersList.innerHTML = html;

      activeFiltersList.querySelectorAll("[data-clear]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const clearType = btn.dataset.clear;
          const value = btn.dataset.value;

          if (clearType === "neighborhood" && neighborhoodSelect) {
            neighborhoodSelect.value = "";
          } else if (clearType === "primary" && value && primarySelect) {
            Array.from(primarySelect.options).forEach((opt) => {
              if (opt.value === value) opt.selected = false;
            });
          } else if (clearType === "amenity" && value && amenitiesSelect) {
            Array.from(amenitiesSelect.options).forEach((opt) => {
              if (opt.value === value) opt.selected = false;
            });
          }

          applyFiltersAndSort();
        });
      });
    }

    function resetAllFilters() {
      if (searchInput) searchInput.value = "";
      if (neighborhoodSelect) neighborhoodSelect.value = "";
      if (primarySelect) Array.from(primarySelect.options).forEach((opt) => (opt.selected = false));
      if (amenitiesSelect) Array.from(amenitiesSelect.options).forEach((opt) => (opt.selected = false));
      applyFiltersAndSort();
    }

    function applyFiltersAndSort() {
      const q = normalize(searchInput?.value || "");
      const sortValue = sortSelect?.value || "az";
      const activeNeighborhood = neighborhoodSelect ? normalize(neighborhoodSelect.value) : "";
      const activePrimaryTypes = getSelectedValues(primarySelect);
      const activeMicrofilters = getSelectedValues(amenitiesSelect);

      const sorted = cards.slice().sort((a, b) => {
        const an = a.dataset.name || "";
        const bn = b.dataset.name || "";

        if (sortValue === "az") return an.localeCompare(bn);

        if (sortValue === "neighborhood") {
          const anb = (a.dataset.neighborhoods || "").split("|")[0] || "";
          const bnb = (b.dataset.neighborhoods || "").split("|")[0] || "";
          return anb.localeCompare(bnb) || an.localeCompare(bn);
        }

        return 0;
      });

      let visible = 0;

      sorted.forEach((card) => {
        const name = card.dataset.name || "";
        const primaryData = card.dataset.primaryTypes || "";
        const neighborhoods = card.dataset.neighborhoods || "";
        const micro = card.dataset.microfilters || "";

        const matchesText =
          !q ||
          name.includes(q) ||
          primaryData.includes(q) ||
          neighborhoods.includes(q) ||
          micro.includes(q);

        const matchesNeighborhood = !activeNeighborhood || neighborhoods.includes(activeNeighborhood);

        // Use tag-based matching for primary types
        const matchesPrimary = businessMatchesPrimaryFilters(primaryData, activePrimaryTypes);

        const matchesMicro =
          activeMicrofilters.size === 0 ||
          Array.from(activeMicrofilters).some((m) => micro.includes(m));

        const show = matchesText && matchesNeighborhood && matchesPrimary && matchesMicro;

        card.style.display = show ? "" : "none";
        if (show) {
          visible++;
          grid?.appendChild(card);
        }
      });

      if (countEl) countEl.textContent = `Showing ${visible} place${visible === 1 ? "" : "s"}`;
      if (emptyState) emptyState.style.display = visible === 0 ? "block" : "none";
      if (grid) grid.style.display = visible === 0 ? "none" : "";

      updateClearButton();
      updateFilterCount();
      updateActiveFiltersSummary();

      if (typeof window.updateMapMarkers === "function") window.updateMapMarkers();
    }

    if (filterToggle && filterPanel && filterToggleText) {
      filterToggle.addEventListener("click", () => {
        const isCollapsed = filterPanel.dataset.collapsed === "true";
        filterPanel.dataset.collapsed = isCollapsed ? "false" : "true";
        filterToggleText.textContent = isCollapsed ? "Hide Filters" : "Show Filters";
      });
    }

    searchInput?.addEventListener("input", applyFiltersAndSort);
    clearBtn?.addEventListener("click", () => {
      if (searchInput) {
        searchInput.value = "";
        searchInput.focus();
      }
      applyFiltersAndSort();
    });

    neighborhoodSelect?.addEventListener("change", applyFiltersAndSort);
    primarySelect?.addEventListener("change", applyFiltersAndSort);
    amenitiesSelect?.addEventListener("change", applyFiltersAndSort);
    sortSelect?.addEventListener("change", applyFiltersAndSort);

    resetAllBtn?.addEventListener("click", resetAllFilters);
    resetFromEmpty?.addEventListener("click", resetAllFilters);

    updateClearButton();
    applyFiltersAndSort();
  </script>
</BaseLayout>