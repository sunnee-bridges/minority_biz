---
import BaseLayout from "../layouts/Base.astro";
import SearchSuggestions from "../components/SearchSuggestions.astro";
import { businesses } from "../lib/businesses";

/**
 * Enhance businesses with a primaryType
 */
const enhanced = businesses.map((b) => ({
  ...b,
  primaryType:
    b.type ||
    (Array.isArray(b.businessCategories) && b.businessCategories[0]) ||
    "Other",
}));

const params = Astro.url.searchParams;

const neighborhoodFromUrl = (params.get("neighborhood") || "").toLowerCase();
const sortFromUrl = params.get("sort") || "az";
const qFromUrl = params.get("q") || "";
const qNorm = (qFromUrl || "").toLowerCase().trim();

const allBusinesses = enhanced;


const allTypes = Array.from(
  new Set(enhanced.map((b) => b.primaryType))
).sort();

const allNeighborhoods = Array.from(
  new Set(enhanced.flatMap((b) => b.neighborhoods || []))
).sort();

// Collect BOTH cuisineTypes and entertainmentTypes and artTypes
// ‚úÖ Build a stable, deduped cuisine list: normalized value -> pretty label
const specialtyMap = new Map<string, string>();

enhanced.forEach((b) => {
  const tags = [...(b.specialties || [])];

  tags.forEach((tag) => {
    const key = normalizeTag(tag); // already lower/trim/collapse spaces
    if (!key) return;
    if (!specialtyMap.has(key)) {
      specialtyMap.set(key, String(tag).trim().replace(/\s+/g, " "));
    }
  });
});

const allSpecialties = Array.from(specialtyMap.entries())
  .map(([value, label]) => ({ value, label }))
  .sort((a, b) => a.label.localeCompare(b.label));


const specialtyFromUrl = (params.get("specialty") || "").toLowerCase().trim();

// If someone arrives with only q=BBQ (older behavior), and BBQ exactly matches a cuisine,
// infer cuisineFromQ so the dropdown filter still works.
const specialtyFromQ = !specialtyFromUrl && qNorm && specialtyMap.has(qNorm) ? qNorm : "";


const initialSpecialty = specialtyFromUrl || specialtyFromQ;

const qForInput = qNorm && initialSpecialty && qNorm === initialSpecialty ? "" : qFromUrl;



function normalizeTag(s: string) {
  return String(s || "")
    .trim()
    .replace(/\s+/g, " ")
    .toLowerCase();
}

// Build a map: normalizedKey -> displayLabel
const microfilterMap = new Map<string, string>();

enhanced.flatMap((b) => b.microfilters || []).forEach((tag) => {
  const key = normalizeTag(tag);
  if (!key) return;

  // Keep first ‚Äúpretty‚Äù label we see
  if (!microfilterMap.has(key)) {
    microfilterMap.set(key, String(tag).trim().replace(/\s+/g, " "));
  }
});

// Now you get stable value + label
const allMicrofilters = Array.from(microfilterMap.entries())
  .map(([value, label]) => ({ value, label }))
  .sort((a, b) => a.label.localeCompare(b.label));


// Helper function for type icons
function getTypeIcon(type: string): string {
  const icons: Record<string, string> = {
    restaurant: "üçΩÔ∏è",
    entertainment: "üéµ",
    catering: "üéâ",
    "food truck": "üöö",
    art: "üé®",
  };
  return icons[type.toLowerCase()] || "üì¶";
}

// Helper function to create slugs
function slugify(str: string): string {
  return String(str)
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

// Helper function for neighborhood slugs (for clickable chips)
function slugForNeighborhood(n: string) {
  return String(n || "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}




// Helper function for amenity icons
function getAmenityIcon(tag: string): string {
  const icons: Record<string, string> = {
    // existing
    takeout: "ü•°",
    "dine-in": "üçΩÔ∏è",
    "outdoor seating": "üå≥",
    delivery: "üöö",
    "vegan options": "üå±",
    "live entertainment": "üéµ",
    "lgbtq+ friendly": "üè≥Ô∏è‚Äçüåà",
    "wine and beer": "üç∑",
    "parking available": "üÖøÔ∏è",
    "pet-friendly patio": "üêæ",
    "live music": "üé∏",

    // dietary
    "100% vegan": "üå±",
    "dairy-free": "ü•õüö´",
    "gluten-free": "üåæüö´",
    "nut-free": "ü•úüö´",
    "soy-free": "ü´òüö´",
    halal: "‚ò™Ô∏è",
    "halal food": "‚ò™Ô∏è",
    vegetarian: "ü•ï",
    "vegetarian options": "ü•ï",
    "all-natural ingredients": "üçÉ",
    "dietary/allergy friendly": "üßë‚Äç‚öïÔ∏è",
    "dietary & allergy friendly": "üßë‚Äç‚öïÔ∏è",

    // food/service
    "accepts reservations": "üìÖ",
    reservations: "üìÖ",
    catering: "üç±",
    "curbside pickup": "üÖøÔ∏èüì¶",
    "drive-thru": "üöóüí®",
    "quick bite": "‚ö°Ô∏èüç¥",
    "small plates": "üçΩÔ∏è‚ú®",
    "happy hour": "‚è∞üçπ",
    alcohol: "üç∏",
    "bar onsite": "üç∫",
    "bar on-site": "üç∫",

    // accessibility + facilities
    "wheelchair accessible": "‚ôøÔ∏è",
    "gender-neutral restroom": "üöª",
    "transgender safespace": "üè≥Ô∏è‚Äç‚ößÔ∏è",
    "transgender safe space": "üè≥Ô∏è‚Äç‚ößÔ∏è",
    "high chairs": "üë∂",
    "kids‚Äô menu": "üßí",
    "kids menu": "üßí",
    "family-friendly": "üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
    "groups welcome": "üë•",

    // parking/transport
    "bike parking": "üö≤",
    "free parking": "üÜìüÖøÔ∏è",
    "valet parking": "üÖøÔ∏èü§µ",

    // vibes / extras
    "heated outdoor seating": "üî•üå≥",
    "pool table": "üé±",
    "juke box": "üìª",
    tourists: "üß≥",
    philanthropic: "ü§ù",
    "veteran owned": "üéñÔ∏è",

    // retail / market / goods
    "specialty market": "üõí",
    "african groceries": "üõíüåç",
    "caribbean groceries": "üõíüå¥",
    "imported goods": "üì¶üåç",
    "cultural products": "üè∫",
    "fabrics and jewelry": "üßµüíé",

    // art / studio / handmade
    "studio services": "üé¨",
    "handmade dishes": "ü´∂üçΩÔ∏è",
    "plant-based soul food": "üå±üç≤",
  };

  return icons[(tag || "").toLowerCase().trim()] || "‚úì";
}


/* --------------------------
   SEO (kept)
--------------------------- */
const pageTitle = "All Businesses ‚Ä¢ Denver Black Guide";
const pageDescription =
  "Browse the Denver Black Guide directory. Filter Black-owned businesses by neighborhood, specialty, and amenities‚Äîor search by name.";

const pageImage = "/og-denver-black-guide.png";

// Canonical should NOT include filters/query to avoid duplicate indexation
const origin =
  import.meta.env.SITE_URL ||
  Astro.url.origin ||
  Astro.site;

const canonicalPath =
  (Astro.url.pathname || "/") === "/"
    ? "/"
    : (Astro.url.pathname || "/").replace(/\/?$/, "/");

// ‚úÖ ADD THIS:
const canonical = new URL(canonicalPath, origin).toString();
const absoluteImage = new URL(pageImage, origin).toString();

// Common SEO practice: don't index internal search/filter result URLs
const isFiltered =
  !!qFromUrl ||
  !!neighborhoodFromUrl ||
  !!initialSpecialty ||
  (sortFromUrl && sortFromUrl !== "az");

const robots = isFiltered
  ? "noindex,follow"
  : "index,follow,max-image-preview:large";

// ItemList (cap to keep JSON-LD payload reasonable)
const listItems = allBusinesses.slice(0, 100).map((b, i) => ({
  "@type": "ListItem",
  position: i + 1,
  name: b.name,
  url: new URL(`/business/${b.slug}/`, origin).toString(),
}));

const siteUrl = new URL("/", origin).toString();

const jsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebPage",
      name: pageTitle,
      url: canonical,
      description: pageDescription,
      primaryImageOfPage: {
        "@type": "ImageObject",
        url: absoluteImage,
      },
      isPartOf: { "@id": `${siteUrl}#website` },
      publisher: { "@id": `${siteUrl}#organization` },

      breadcrumb: {
        "@type": "BreadcrumbList",
        itemListElement: [
          {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: siteUrl,
          },
          {
            "@type": "ListItem",
            position: 2,
            name: "All businesses",
            item: canonical,
          },
        ],
      },
    },
    {
      "@type": "ItemList",
      name: "Denver Black Guide directory",
      itemListOrder: "https://schema.org/ItemListOrderAscending",
      numberOfItems: allBusinesses.length,
      itemListElement: listItems,
    },
  ],
};
---

<BaseLayout 
    title={pageTitle} 
    description={pageDescription} 
    image={pageImage}
    canonical={canonical}
    robots={robots}
    jsonLd={jsonLd}
    >
    <meta slot="head" name="author" content="Denver Black Guide" />

    <meta slot="head" property="og:site_name" content="Denver Black Guide" />
    <meta slot="head" property="og:locale" content="en_US" />
    <meta slot="head" property="og:image:alt" content="Denver Black Guide directory preview" />
    <meta slot="head" name="twitter:image:alt" content="Denver Black Guide directory preview" />

   
  

  <div class="directory">
    <nav aria-label="Breadcrumb" class="breadcrumb">
      <ol class="breadcrumb__list">
        <li class="breadcrumb__item">
          <a href="/" class="breadcrumb__link">Home</a>
          <span class="breadcrumb__separator">/</span>
        </li>
        <li class="breadcrumb__item">
          <span>All businesses</span>
        </li>
      </ol>
    </nav>

    <header class="directory__head">
      <h1 class="directory__title">All Businesses</h1>

      <div class="directory__stats">
        <span class="stat">
          <strong>{allBusinesses.length}</strong> businesses
        </span>
        <span class="stat-separator">¬∑</span>
        <span class="stat">
          <strong>{allTypes.length}</strong> types
        </span>
        <span class="stat-separator">¬∑</span>
        <span class="stat">
          <strong>{allNeighborhoods.length}</strong> neighborhoods
        </span>
      </div>

      <p class="directory__subtitle">
        Browse our complete directory with advanced filters ‚Äî find exactly what you're
        looking for by type, neighborhood, specialty, and amenities.
      </p>
    </header>

    <!-- FILTERS / CONTROLS -->
    <section class="filter-panel" id="filters" data-collapsed="true">
      <button class="filter-panel__toggle" id="filter-toggle" type="button">
        <span id="filter-toggle-text">Show filters</span>
        <span class="filter-badge" id="filter-count">0</span>
        <span class="filter-toggle__icon">‚ñº</span>
      </button>

      <div class="filter-panel__content">
        <div class="filter-row filter-row--top">
          <div class="filter-search-wrap">
            <label for="search" class="filter-label">Search</label>
            <div class="filter-search">
              <svg class="filter-search__icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M7 13A6 6 0 1 0 7 1a6 6 0 0 0 0 12zM14 14l-3-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>

              <input
                id="search"
                name="directory-search"
                type="search"
                class="filter-search__input"
                placeholder="Search by name, specialty, neighborhood, or amenity..."
                autocomplete="off"
                autocapitalize="none"
                spellcheck="false"
                value={qForInput}
              />

              <button type="button" id="search-clear" class="filter-search__clear" aria-label="Clear search">
                ‚úï
              </button>

              <!-- ‚úÖ Live suggestions dropdown (must be inside .filter-search) -->
  <div id="all-search-suggestions" class="search-suggestions" style="display:none;"></div>

  <!-- ‚úÖ Attach behavior -->
  <SearchSuggestions
     mode="filter"
    inputId="search"
    panelId="all-search-suggestions"
    neighborhoodMode="slug"
    searchData={enhanced.map((b) => ({
      name: b.name,
      slug: b.slug,
      type: b.primaryType,
      neighborhoods: b.neighborhoods || [],
      specialties: [...(b.specialties || [])],
    }))}
  />
            </div>

            <p class="filter-search__hint">Try: "soul food", "takeout", "Five Points", "live music"</p>
          </div>

          <div class="filter-sort-wrap">
            <label for="sort" class="filter-label">Sort by</label>
            <select id="sort" class="filter-sort">
              <option value="az" selected={sortFromUrl === "az"}>A‚ÄìZ (Name)</option>
              <option value="neighborhood" selected={sortFromUrl === "neighborhood"}>Neighborhood</option>
              <option value="type" selected={sortFromUrl === "type"}>Type</option>
            </select>
          </div>
        </div>

        <div class="filter-row">
          <span class="filter-label filter-label--pill">Browse by type</span>
          <div class="filter-chips filter-chips--scroll">
            <a href="/" class="chip chip--link chip--active">
              <span class="chip__icon">üè†</span>
              All
            </a>

            {allTypes.map((t) => {
              const icon = getTypeIcon(t);
              const slug = slugify(t);
              return (
                <a href={`/type/${slug}/`} class="chip chip--link">
                  <span class="chip__icon">{icon}</span>
                  {t}
                </a>
              );
            })}
          </div>
        </div>




        <div class="filter-dropdowns">
          <div class="filter-dropdown">
            <label for="neighborhood-select" class="filter-label">Neighborhood</label>
            <select id="neighborhood-select" class="filter-select">
              <option value="">All neighborhoods</option>
              {allNeighborhoods.map((n) => (
                <option value={n.toLowerCase()} selected={neighborhoodFromUrl === n.toLowerCase()}>
                  {n}
                </option>
              ))}
            </select>
          </div>

          {allSpecialties.length > 0 && (
            <div class="filter-dropdown">
              <label for="specialty-select" class="filter-label">specialty</label>
              <div class="filter-match">
                <span class="filter-match__label">Match</span>
                <div class="filter-match__segmented" role="group" aria-label="Specialty match mode">
                  <label class="filter-match__option">
                    <input type="radio" name="specialty-match" value="any" checked />
                    <span>Any = OR</span>
                  </label>
                  <label class="filter-match__option">
                    <input type="radio" name="specialty-match" value="all" />
                    <span>All = AND</span>
                  </label>
                </div>
              </div>

              <select id="specialty-select" class="filter-select" multiple size="4">
                {allSpecialties.map(({ value, label }) => (
                  <option value={value} selected={initialSpecialty === value}>
                    {label}
                  </option>
                ))}
              </select>
              <p class="filter-dropdown__hint">Hold Ctrl/Cmd to select multiple</p>
            </div>
          )}

          {allMicrofilters.length > 0 && (
            <div class="filter-dropdown">
              <label for="amenities-select" class="filter-label">Amenities &amp; options</label>
              <div class="filter-match">
                <span class="filter-match__label">Match</span>
                <div class="filter-match__segmented" role="group" aria-label="Amenities match mode">
                  <label class="filter-match__option">
                    <input type="radio" name="amenities-match" value="any" checked />
                    <span>Any</span>
                  </label>
                  <label class="filter-match__option">
                    <input type="radio" name="amenities-match" value="all" />
                    <span>All</span>
                  </label>
                </div>
              </div>

              <select id="amenities-select" class="filter-select" multiple size="4">
                {allMicrofilters.map(({ value, label }) => (
                  <option value={value}>{label}</option>
                ))}
              </select>
              <p class="filter-dropdown__hint">Hold Ctrl/Cmd to select multiple</p>
            </div>
          )}
        </div>

        <div class="filter-row filter-row--actions">
          <button type="button" id="reset-all-filters" class="btn-reset-all">
            Clear all filters
          </button>
        </div>
      </div>
    </section>

    <div id="active-filters-summary" class="active-filters" style="display:none;">
      <span class="active-filters__label">Active</span>
      <div id="active-filters-list" class="active-filters__list"></div>
    </div>

    <!-- RESULTS -->
    <section aria-label="Business results" class="directory__results">
      <p id="results-count" class="directory__results-count">
        Showing {allBusinesses.length} place{allBusinesses.length === 1 ? "" : "s"}
      </p>

      <div id="empty-state" class="empty-state" style="display:none;">
        <div class="empty-state__icon">üîç</div>
        <h3 class="empty-state__title">No businesses found</h3>
        <p class="empty-state__message">Try adjusting your filters or search terms.</p>
        <button id="reset-from-empty" class="empty-state__button">Clear all filters</button>
      </div>

      <div id="results-grid" class="directory__grid">
        {allBusinesses.map((b) => {
          const type = b.primaryType;
          const name = b.name || "";
          const neighborhoods = b.neighborhoods || [];
          const microfilters = b.microfilters || [];

         const specialties = b.specialties || [];
         const allTypeLabels = specialties;

          return (
            <a
              href={`/business/${b.slug}/`}
              class="business-card-link"
              data-slug={b.slug}
              data-name={name.toLowerCase()}
              data-type={String(type).toLowerCase()}
              data-specialties={allTypeLabels.map(normalizeTag).join("|")}
              data-neighborhoods={neighborhoods.join("|").toLowerCase()}
              data-microfilters={microfilters.map(normalizeTag).join("|")}
            >
             <article class="card business-card">
  <!-- NAME -->
  <h2 class="business-card__name">{name}</h2>

  <!-- NEIGHBORHOOD -->
  <div class="business-card__row business-card__row--neighborhood">
    <span class="row-icon">üìç</span>

    {neighborhoods.length > 0 ? (
      <>
        <button
          type="button"
          class="neighborhood-chip"
          data-neighborhood-slug={slugForNeighborhood(neighborhoods[0])}
          aria-label={`View businesses in ${neighborhoods[0]}`}
        >
          {neighborhoods[0]}
        </button>

        {neighborhoods.length > 1 && (
          <span class="row-muted">+{neighborhoods.length - 1}</span>
        )}
      </>
    ) : (
      <span class="row-muted">Location TBD</span>
    )}
  </div>

  <!-- TYPE + SPECIALTIES -->
  <p class="business-card__meta">
    <span class="business-card__type">{type}</span>

    {allTypeLabels.length > 0 && (
      <>
        <span class="meta-sep">¬∑</span>
        <span class="business-card__specialties">
          {allTypeLabels.slice(0, 2).join(", ")}
          {allTypeLabels.length > 2 && ` +${allTypeLabels.length - 2}`}
        </span>
      </>
    )}
  </p>

  <!-- AMENITIES (2 max) + COUNT -->
  {microfilters.length > 0 && (
    <div class="business-card__amenities-row">
      <div class="business-card__amenities">
        {microfilters.slice(0, 2).map((tag) => {
          const icon = getAmenityIcon(tag);
          return (
            <span class="amenity-tag" title={tag}>
              <span class="amenity-tag__icon">{icon}</span>
              <span class="amenity-tag__label">{tag}</span>
            </span>
          );
        })}
      </div>

      {microfilters.length > 2 && (
        <span class="business-card__more">+{microfilters.length - 2} more</span>
      )}
    </div>
  )}

  <!-- FOOTER: EST + CTA -->
  <div class="business-card__footer">
    {b.yearEstablished ? (
      <span class="business-card__est">
        <span class="row-icon">üìÖ</span> Est. {b.yearEstablished}
      </span>
    ) : (
      <span></span>
    )}

    <span class="business-card__action">View Details ‚Üí</span>
  </div>
</article>


            </a>
          );
        })}
      </div>
    </section>
  </div>

  <style>
    /* (Keep your existing styles ‚Äî below are the pieces that make it match [type].astro cards) */

    /* ====== FILTER PANEL + DROPDOWNS (match [type].astro) ====== */

.directory {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.directory__head {
  margin-bottom: 0.25rem;
}

.directory__title {
  margin: 0 0 0.5rem;
  font-size: 1.6rem;
  line-height: 1.2;
}

.directory__stats {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.stat strong {
  color: var(--text-main);
  font-weight: 600;
}

.stat-separator {
  opacity: 0.5;
}

.directory__subtitle {
  margin: 0;
  font-size: 0.9rem;
  color: var(--text-muted);
  max-width: 42rem;
}

/* FILTER PANEL */
.filter-panel {
  border-radius: 0.9rem;
  border: 1px solid var(--border-subtle);
  background: var(--bg-elevated);
  box-shadow: var(--shadow-soft);
  padding: 0.9rem 1rem 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.filter-panel__toggle {
  display: none;
  width: 100%;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem 1rem;
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-main);
  gap: 0.75rem;
}

.filter-badge {
  background: var(--accent);
  color: white;
  padding: 0.15rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.7rem;
  font-weight: 600;
  min-width: 1.5rem;
  text-align: center;
}

.filter-toggle__icon {
  font-size: 0.75rem;
  transition: transform 0.2s;
}

.filter-panel[data-collapsed="false"] .filter-toggle__icon {
  transform: rotate(180deg);
}

@media (max-width: 768px) {
  .filter-panel__toggle {
    display: flex;
  }

  .filter-panel[data-collapsed="true"] .filter-panel__content {
    display: none;
  }

  .filter-panel {
    padding: 0;
  }

  .filter-panel__content {
    padding: 0.9rem 1rem 1rem;
  }
}

.filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem 0.6rem;
  align-items: flex-start;
}

.filter-row--top {
  align-items: flex-end;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.filter-row--actions {
  justify-content: flex-end;
  padding-top: 0.5rem;
  border-top: 1px solid var(--border-subtle);
}

.filter-search-wrap {
  flex: 1 1 220px;
  min-width: 0;
}

.filter-sort-wrap {
  flex: 0 0 auto;
  min-width: 150px;
}

.filter-label {
  display: block;
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 0.15rem; /* matches [type].astro tighter label spacing */
}

.filter-label--pill {
  margin-top: 0.25rem;
  min-width: 75px;
}

.filter-search {
  position: relative;
  overflow: visible;
}

.filter-search__icon {
  position: absolute;
  left: 0.75rem;
  color: var(--text-muted);
  pointer-events: none;
  opacity: 0.7;
}

.filter-search__input {
  width: 100%;
  border-radius: 9999px;
  border: 1px solid var(--border-subtle);
  background: var(--bg-page);
  padding: 0.4rem 2rem 0.4rem 2.5rem;
  font-size: 0.85rem;
}

.filter-search__input:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 1px;
}

.filter-search__clear {
  position: absolute;
  right: 0.4rem;
  border: none;
  background: transparent;
  font-size: 0.8rem;
  cursor: pointer;
  color: var(--text-muted);
  padding: 0.1rem;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s;
}

.filter-search__clear.is-visible {
  opacity: 1;
  pointer-events: auto;
}

.filter-search__clear:hover {
  color: var(--accent-strong);
}

.filter-search__hint {
  margin: 0.35rem 0 0;
  font-size: 0.7rem;
  color: var(--text-muted);
  font-style: italic;
}

.filter-sort {
  width: 100%;
  border-radius: 9999px;
  border: 1px solid var(--border-subtle);
  background: var(--bg-page);
  padding: 0.35rem 0.75rem;
  font-size: 0.8rem;
}

/* FILTER DROPDOWNS */
.filter-dropdowns {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 0.5rem;
}

.filter-dropdown {
  display: flex;
  flex-direction: column;
}

.filter-select {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border-radius: 0.5rem;
  border: 1px solid var(--border-subtle);
  background: var(--bg-page);
  font-size: 0.85rem;
  color: var(--text-main);
  cursor: pointer;
}

.filter-select[multiple] {
  min-height: 120px;
  padding: 0.25rem;
}

.filter-select option {
  padding: 0.4rem 0.5rem;
  border-radius: 0.25rem;
  margin: 0.1rem 0;
}

.filter-select option:checked {
  background: var(--accent-soft);
  color: var(--accent-strong);
}

.filter-select:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 1px;
}

.filter-dropdown__hint {
  margin: 0.25rem 0 0;
  font-size: 0.65rem;
  color: var(--text-muted);
  font-style: italic;
}

.filter-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
}

.filter-chips--scroll {
  max-height: 80px;
  overflow-y: auto;
  padding-right: 0.25rem;
}

.filter-match {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.35rem;
}

.filter-match__label {
  font-size: 0.65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
}

.filter-match__segmented {
  display: inline-flex;
  border: 1px solid var(--border-subtle);
  border-radius: 9999px;
  overflow: hidden;
  background: var(--bg-page);
}

.filter-match__option {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.25rem 0.65rem;
  cursor: pointer;
  font-size: 0.75rem;
  color: var(--text-muted);
  user-select: none;
}

.filter-match__option input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.filter-match__option:has(input:checked) {
  background: var(--accent-soft);
  color: var(--accent-strong);
  border-left: 1px solid var(--border-subtle);
  border-right: 1px solid var(--border-subtle);
}

.filter-match__option:first-child:has(input:checked),
.filter-match__option:last-child:has(input:checked) {
  border-left: none;
  border-right: none;
}


/* LIVE SUGGESTION STYLES (same as homepage) */
#all-search-suggestions.search-suggestions {
  position: absolute;
  top: calc(100% + 0.5rem);
  left: 0;
  right: 0;
  width: 100%;

  background: var(--bg-elevated);
  border: 2px solid var(--border-subtle);
  border-radius: 0.875rem;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
  max-height: 420px;
  overflow-y: auto;
  z-index: 9999;

  pointer-events: auto;
  text-align: left !important;
}

#all-search-suggestions.search-suggestions * {
  text-align: left !important;
}

#all-search-suggestions .search-suggestions__section {
  padding: 0.5rem 0;
}

#all-search-suggestions .search-suggestions__section:not(:last-child) {
  border-bottom: 1px solid var(--border-subtle);
}

#all-search-suggestions .search-suggestions__header {
  padding: 0.5rem 1rem 0.25rem 1rem;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 0.5rem;
  cursor: default;
}

#all-search-suggestions .search-suggestions__item {
  position: relative;
  display: flex;
  align-items: flex-start;
  justify-content: flex-start;
  padding: 0.75rem 1.25rem 0.75rem 3rem;
  margin: 0;
  border-left: 3px solid transparent;
  cursor: pointer !important;
  background: var(--bg-elevated);
  transition: background 0.18s ease, border-color 0.18s ease, transform 0.12s ease;
}

#all-search-suggestions .search-suggestions__item::before {
  content: "‚Ä¢";
  position: absolute;
  left: 2rem;
  top: 0.95rem;
  font-size: 0.75rem;
  color: var(--text-muted);
}

#all-search-suggestions .search-suggestions__content {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0.25rem;
  width: 100%;
}

#all-search-suggestions .search-suggestions__text {
  color: var(--text-main);
  font-weight: 600;
  font-size: 0.95rem;
  line-height: 1.3;
  width: 100%;
  display: block;
}

#all-search-suggestions .search-suggestions__meta {
  font-size: 0.8rem;
  color: var(--text-muted);
  line-height: 1.4;
  width: 100%;
  display: block;
}

#all-search-suggestions .search-suggestions__item:hover,
#all-search-suggestions .search-suggestions__item--active {
  background: var(--accent-soft);
  border-left-color: var(--accent);
  transform: translateX(2px);
}

#all-search-suggestions .search-suggestions__item:hover .search-suggestions__text,
#all-search-suggestions .search-suggestions__item--active .search-suggestions__text {
  text-decoration: underline;
  text-decoration-thickness: 1.5px;
  text-underline-offset: 2px;
}

#all-search-suggestions .search-suggestions__empty {
  padding: 2rem 1rem;
  text-align: center;
  color: var(--text-muted);
  font-size: 0.85rem;
}

.btn-reset-all {
  padding: 0.4rem 1rem;
  border-radius: 9999px;
  border: 1px solid var(--border-subtle);
  background: transparent;
  font-size: 0.8rem;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
}

.btn-reset-all:hover {
  border-color: var(--accent);
  color: var(--accent-strong);
  background: var(--accent-soft);
}

/* ACTIVE FILTERS */
.active-filters {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1rem;
  background: var(--bg-elevated);
  border-radius: 0.5rem;
  border: 1px solid var(--border-subtle);
  flex-wrap: wrap;
}

.active-filters__label {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.active-filters__list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  flex: 1;
}

.active-filter-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.25rem 0.65rem;
  background: var(--accent-soft);
  border: 1px solid var(--accent);
  border-radius: 9999px;
  font-size: 0.75rem;
  color: var(--accent-strong);
}

.active-filter-pill__remove {
  background: none;
  border: none;
  color: inherit;
  cursor: pointer;
  font-size: 0.9rem;
  padding: 0;
  line-height: 1;
  opacity: 0.7;
}

.active-filter-pill__remove:hover {
  opacity: 1;
}

/* EMPTY STATE */
.empty-state {
  text-align: center;
  padding: 3rem 1rem;
}

.empty-state__icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state__title {
  margin: 0 0 0.5rem;
  font-size: 1.25rem;
  color: var(--text-main);
}

.empty-state__message {
  margin: 0 0 1.5rem;
  font-size: 0.9rem;
  color: var(--text-muted);
}

.empty-state__button {
  padding: 0.6rem 1.5rem;
  border-radius: 9999px;
  border: 1px solid var(--accent);
  background: var(--accent);
  color: white;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
}

.empty-state__button:hover {
  background: var(--accent-strong);
  transform: translateY(-1px);
}

/* ====== RESULTS GRID + CARDS (your existing card styling, kept) ====== */

.directory__results {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.directory__results-count {
  margin: 0;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.directory__grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  gap: 0.9rem;
}


.business-card-link {
  text-decoration: none;
  color: inherit;
  display: block;
}

.business-card {
  padding: 1rem 1.1rem 1.1rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  position: relative;
  transition: transform 0.15s, box-shadow 0.15s;
  height: 100%;
}

.business-card-link:hover .business-card {
  transform: translateY(-2px);
  box-shadow: var(--shadow-soft);
}

.business-card__name {
  margin: 0 0 0.1rem;
  font-size: 1rem;
  color: var(--text-main);
  line-height: 1.3;
}

.business-card__quick-info {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 0.15rem;
}

.quick-info-item {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.quick-info-item__icon {
  font-size: 0.85rem;
}

.business-card__meta {
  margin: 0;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.business-card__type {
  font-weight: 600;
  color: var(--text-main);
}

.business-card__amenities {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  margin-top: 0.25rem;
}

.amenity-tag {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.2rem 0.5rem;
  background: var(--bg-elevated);
  border: 1px solid var(--border-subtle);
  border-radius: 0.35rem;
  font-size: 0.7rem;
  color: var(--text-main);
}

.amenity-tag__icon {
  font-size: 0.85rem;
}

.business-card__more {
  font-size: 0.7rem;
  color: var(--text-muted);
  padding: 0.2rem 0.5rem;
}

/* ‚úÖ Match [type].astro ‚Äúhover reveal‚Äù action */
.business-card__action {
  margin-top: auto;
  padding-top: 0.5rem;
  font-size: 0.8rem;
  color: var(--accent);
  font-weight: 500;
  opacity: 0;
  transition: opacity 0.15s;
}

 .business-card__neighborhood,
.business-card__est {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.business-card__neighborhood-icon,
.business-card__est-icon {
  font-size: 0.85rem;
}

.business-card__more-row {
  margin-top: -0.15rem;
}

.business-card__more {
  font-size: 0.72rem;
  color: var(--text-muted);
}

/* --- UX card layout helpers --- */

.business-card__row {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.78rem;
  color: var(--text-muted);
}

.row-icon {
  font-size: 0.9rem;
}

.row-muted {
  color: var(--text-muted);
  font-size: 0.75rem;
}

/* Keep this single neighborhood chip compact */
.business-card__row--neighborhood .neighborhood-chip {
  border: none;
  background: transparent;
  padding: 0;
  cursor: pointer;
  color: var(--accent);
  font-weight: 600;
  font-size: 0.82rem;
  text-decoration: underline;
  text-underline-offset: 2px;
}
.business-card__row--neighborhood .neighborhood-chip:hover {
  color: var(--accent-strong);
}

.business-card__meta {
  margin: 0;
  font-size: 0.82rem;
  color: var(--text-muted);
  display: flex;
  gap: 0.4rem;
  flex-wrap: wrap;
  align-items: baseline;
}

.business-card__type {
  font-weight: 650;
  color: var(--text-main);
}

.meta-sep {
  opacity: 0.6;
}

.business-card__specialties {
  color: var(--text-muted);
}

/* Amenities + +N more */
.business-card__amenities-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
}

.business-card__more {
  font-size: 0.72rem;
  color: var(--text-muted);
  white-space: nowrap;
}

/* Footer row keeps Est + CTA aligned and always visible */
.business-card__footer {
  margin-top: auto;
  padding-top: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
}

.business-card__est {
  font-size: 0.75rem;
  color: var(--text-muted);
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
}

/* Optional: clamp name to keep grid heights consistent */
.business-card__name {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* CTA visible (better on mobile) */
.business-card__action {
  opacity: 1; /* override your hover-only style if needed */
}

.business-card-link:hover .business-card__action {
  opacity: 1;
}

/* ‚úÖ Neighborhood chip styling (same as your type page) */
.neighborhood-chip-row {
  display: inline-flex;
  gap: 0.35rem;
  flex-wrap: wrap;
  align-items: center;
}

.neighborhood-chip {
  border: none;
  background: transparent;
  padding: 0;
  cursor: pointer;
  color: var(--accent);
  font-weight: 600;
  font-size: 0.8rem;
  text-decoration: underline;
  text-underline-offset: 2px;
}

.neighborhood-chip:hover {
  color: var(--accent-strong);
}

.neighborhood-chip:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
  border-radius: 0.35rem;
}

.neighborhood-more {
  font-size: 0.75rem;
  color: var(--text-muted);
}

/* Responsive */
@media (max-width: 640px) {
  .filter-panel {
    padding-inline: 0;
  }

  .directory__title {
    font-size: 1.4rem;
  }

  .directory__grid {
    grid-template-columns: 1fr;
  }

  .filter-dropdowns {
    grid-template-columns: 1fr;
  }
}

/* =========================================
   ALL.ASTRO ‚Äî Business card footer fix
   Est. left + View Details right (stable)
   Paste this at the VERY BOTTOM of the <style>
   ========================================= */

/* Ensure cards are true vertical stacks and can pin footer to bottom */
#results-grid .business-card {
  display: flex;
  flex-direction: column;
  height: 100%;
  gap: 0.55rem;
}

/* Row helpers used by your markup */
#results-grid .business-card__row {
  display: flex;
  align-items: center;
  gap: 0.45rem;
  min-width: 0;
}

#results-grid .row-icon {
  flex: 0 0 auto;
  font-size: 0.9rem;
  line-height: 1;
}

#results-grid .row-muted {
  color: var(--text-muted);
  font-size: 0.8rem;
  font-weight: 600;
}

/* Meta line: keep tidy and wrapping sane */
#results-grid .business-card__meta {
  margin: 0;
  font-size: 0.82rem;
  color: var(--text-muted);
  line-height: 1.35;

  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  align-items: baseline;
}

#results-grid .business-card__type {
  font-weight: 750;
  color: var(--text-main);
}

#results-grid .meta-sep {
  opacity: 0.65;
  margin: 0 0.2rem;
}

/* Amenities row: allow "+N more" to sit at end */
#results-grid .business-card__amenities-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  flex-wrap: wrap;
}

#results-grid .business-card__more {
  white-space: nowrap;
}

/* ‚úÖ Footer pinned to bottom + fixed left/right layout */
#results-grid .business-card__footer {
  margin-top: auto;
  padding-top: 0.6rem;
  border-top: 1px solid var(--border-subtle);

  display: grid;
  grid-template-columns: 1fr auto;
  align-items: center;
  gap: 0.75rem;
}

/* Est. stays left */
#results-grid .business-card__est {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;

  font-size: 0.8rem;
  color: var(--text-muted);
  white-space: nowrap;
}

/* ‚úÖ CTA stays right, no hover-only disappearance */
#results-grid .business-card__action {
  /* override older duplicated rules */
  margin-top: 0 !important;
  padding-top: 0 !important;

  display: inline-flex;
  align-items: center;
  justify-content: flex-end;

  font-size: 0.85rem;
  font-weight: 800;
  color: var(--accent);
  white-space: nowrap;

  opacity: 1 !important;
  transition: transform 0.15s, opacity 0.15s;
}

/* Nice micro-interaction */
#results-grid .business-card-link:hover .business-card__action,
#results-grid .business-card-link:focus-visible .business-card__action,
#results-grid .business-card-link:focus-within .business-card__action {
  transform: translateX(2px);
}

/* Optional: keep ‚Äúsubtle reveal‚Äù on hover without hiding on mobile */
@media (hover: hover) {
  #results-grid .business-card__action {
    opacity: 0.92 !important;
  }
  #results-grid .business-card-link:hover .business-card__action {
    opacity: 1 !important;
  }
}

/* Name clamp (keeps grid heights more even) */
#results-grid .business-card__name {
  margin: 0;
  font-size: 1rem;
  font-weight: 850;
  line-height: 1.2;

  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Neighborhood chip: prevent crazy wrapping */
#results-grid .neighborhood-chip {
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}


    

    /* ‚úÖ Match [type].astro clickable-card wrapper behavior */
    .business-card-link {
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .business-card {
      padding: 1rem 1.1rem 1.1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      position: relative;
      transition: transform 0.15s, box-shadow 0.15s;
      height: 100%;
    }

    .business-card-link:hover .business-card {
      transform: translateY(-2px);
      box-shadow: var(--shadow-soft);
    }

    .business-card__name {
      margin: 0 0 0.1rem;
      font-size: 1rem;
      color: var(--text-main);
      line-height: 1.3;
    }

    .business-card__quick-info {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.15rem;
    }

    .quick-info-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .quick-info-item__icon {
      font-size: 0.85rem;
    }

    .business-card__meta {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .business-card__type {
      font-weight: 600;
      color: var(--text-main);
    }

    .business-card__amenities {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.25rem;
    }

    .amenity-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.2rem 0.5rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 0.35rem;
      font-size: 0.7rem;
      color: var(--text-main);
    }

    .amenity-tag__icon {
      font-size: 0.85rem;
    }

    .business-card__more {
      font-size: 0.7rem;
      color: var(--text-muted);
      padding: 0.2rem 0.5rem;
    }

    /* ‚úÖ Match [type].astro ‚Äúhover reveal‚Äù action */
    .business-card__action {
      margin-top: auto;
      padding-top: 0.5rem;
      font-size: 0.8rem;
      color: var(--accent);
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .business-card-link:hover .business-card__action {
      opacity: 1;
    }

    /* ‚úÖ Neighborhood chip styling (same as your type page) */
    .neighborhood-chip-row {
      display: inline-flex;
      gap: 0.35rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .neighborhood-chip {
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
      color: var(--accent);
      font-weight: 600;
      font-size: 0.8rem;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .neighborhood-chip:hover {
      color: var(--accent-strong);
    }

    .neighborhood-chip:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
      border-radius: 0.35rem;
    }

    .neighborhood-more {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
  </style>

  <script is:inline define:vars={{ neighborhoodFromUrl, sortFromUrl, qFromUrl }}>
(function () {
  // --- Typed lookups (also helps astro check) ---
  const searchInput = document.getElementById("search");
  const clearBtn = document.getElementById("search-clear");
  const sortSelect = document.getElementById("sort");
  const neighborhoodSelect = document.getElementById("neighborhood-select");
  const specialtySelect = document.getElementById("specialty-select");
  const amenitiesSelect = document.getElementById("amenities-select");
  const grid = document.getElementById("results-grid");
  const countEl = document.getElementById("results-count");
  const emptyState = document.getElementById("empty-state");
  const filterToggle = document.getElementById("filter-toggle");
  const filterToggleText = document.getElementById("filter-toggle-text");
  const filterPanel = document.getElementById("filters");
  const filterCount = document.getElementById("filter-count");
  const activeFiltersSummary = document.getElementById("active-filters-summary");
  const activeFiltersList = document.getElementById("active-filters-list");
  const resetAllBtn = document.getElementById("reset-all-filters");
  const resetFromEmpty = document.getElementById("reset-from-empty");

  if (!grid) return;

  const cards = Array.from(grid.querySelectorAll(".business-card-link"));

  function normalize(str) {
    return String(str || "").toLowerCase().trim().replace(/\s+/g, " ");
  }

  function getSelectedValues(selectElement) {
    if (!selectElement) return new Set();
    const selected = Array.from(selectElement.selectedOptions);
    return new Set(selected.map((opt) => normalize(opt.value)));
  }

  function getRadioValue(name, fallback = "any") {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? el.value : fallback;
  }

  function pipeToTokenSet(pipeString) {
    // Split once, store forever (cached per card)
    return new Set(
      String(pipeString || "")
        .toLowerCase()
        .split("|")
        .map((s) => normalize(s))
        .filter(Boolean)
    );
  }

  function updateActiveFiltersSummary() {
  if (!activeFiltersSummary || !activeFiltersList) return;

  const count = getActiveFilterCount();
  if (count === 0) {
    activeFiltersSummary.style.display = "none";
    activeFiltersList.innerHTML = "";
    return;
  }

  activeFiltersSummary.style.display = "flex";

  let html = "";

  // Neighborhood
  if (neighborhoodSelect && neighborhoodSelect.value) {
    const label =
      neighborhoodSelect.options[neighborhoodSelect.selectedIndex]?.text || "Neighborhood";
    html += `<span class="active-filter-pill">
      üìç ${label}
      <button class="active-filter-pill__remove" type="button" data-clear="neighborhood">√ó</button>
    </span>`;
  }

  // Cuisine(s)
  const selectedSpecialtyVals = new Set();
    if (specialtySelect) {
      Array.from(specialtySelect.selectedOptions).forEach((opt) => {
        const v = normalize(opt.value);
        if (!v || selectedSpecialtyVals.has(v)) return;
        selectedSpecialtyVals.add(v);

        html += `<span class="active-filter-pill">
          ${opt.text}
          <button class="active-filter-pill__remove" type="button" data-clear="specialty" data-value="${opt.value}">√ó</button>
        </span>`;
      });
    }

  // Amenities
  if (amenitiesSelect) {
    Array.from(amenitiesSelect.selectedOptions).forEach((opt) => {
      html += `<span class="active-filter-pill">
        ${opt.text}
        <button class="active-filter-pill__remove" type="button" data-clear="amenity" data-value="${opt.value}">√ó</button>
      </span>`;
    });
  }

  // Search text
  if (searchInput && searchInput.value.trim()) {
    const qv = normalize(searchInput.value);
    if (!selectedSpecialtyVals.has(qv)) {
      const safe = searchInput.value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
      html += `<span class="active-filter-pill">
        üîé ${safe}
        <button class="active-filter-pill__remove" type="button" data-clear="search">√ó</button>
      </span>`;
    }
  }

  // Match mode pills (optional)
  const specialtyMode = getRadioValue("specialty-match", "any");
  const amenitiesMode = getRadioValue("amenities-match", "any");
  if (specialtyMode === "all") {
  html += `<span class="active-filter-pill">
    Specialty: All
    <button class="active-filter-pill__remove" type="button" data-clear="specialty-mode">√ó</button>
  </span>`;
}
  if (amenitiesMode === "all") {
    html += `<span class="active-filter-pill">
      Amenities: All
      <button class="active-filter-pill__remove" type="button" data-clear="amenities-mode">√ó</button>
    </span>`;
  }

  activeFiltersList.innerHTML = html;
}


  // --- Cache per-card data ONCE (biggest perf win) ---
  const cardData = cards.map((el) => {
    const name = normalize(el.dataset.name);
    const type = normalize(el.dataset.type);
    const neighborhoodsPipe = normalize(el.dataset.neighborhoods);
    const specialtiesPipe = normalize(el.dataset.specialties);
    const microPipe = normalize(el.dataset.microfilters);

    const neighborhoodsTokens = pipeToTokenSet(neighborhoodsPipe);
    const specialtyTokens = pipeToTokenSet(specialtiesPipe);
    const amenityTokens = pipeToTokenSet(microPipe);

    // One combined field for text searching
    const searchBlob = `${name} ${neighborhoodsPipe} ${specialtiesPipe} ${microPipe}`;

    // First neighborhood for sorting
    const firstNeighborhood = (neighborhoodsPipe.split("|")[0] || "").trim();

    return {
      el,
      name,
      type,
      firstNeighborhood,
      neighborhoodsTokens,
      specialtyTokens,
      amenityTokens,
      searchBlob,
    };
  });

// --- Initial values: read URL in browser (static prerender-safe) ---
// --- Initial values: read URL in browser (static prerender-safe) ---
const urlParams = new URLSearchParams(window.location.search);

const qInit = urlParams.get("q") || "";
const neighborhoodInit = normalize(urlParams.get("neighborhood") || "");
const sortInit = urlParams.get("sort") || "az";
const specialtyInitRaw = normalize(urlParams.get("specialty") || urlParams.get("cuisine") || "");


let qEffective = qInit; // what we'll actually apply to the input/UI

// 0) Set neighborhood + sort first
if (neighborhoodSelect) neighborhoodSelect.value = neighborhoodInit;
if (sortSelect) sortSelect.value = sortInit;

// 1) Select cuisine first (so dedupe has real selected values to compare against)
if (specialtySelect) {
  let specialtyToSelect = specialtyInitRaw;

  // If no specialty= but q exactly matches an option, select specialty from q
  if (!specialtyToSelect && qInit) {
    const qN = normalize(qInit);
    const hasExact = Array.from(specialtySelect.options).some(
      (opt) => normalize(opt.value) === qN
    );
    if (hasExact) specialtyToSelect = qN;
  }

  if (specialtyToSelect) {
    Array.from(specialtySelect.options).forEach((opt) => {
      opt.selected = normalize(opt.value) === specialtyToSelect;
    });
  }
}


// 2) NOW dedupe: if q matches selected cuisine, drop q + clean URL
const qN = normalize(qInit);
const selectedSpecialtyValues = specialtySelect ? getSelectedValues(specialtySelect) : new Set();

const qDuplicatesSpecialty =
  (!!specialtyInitRaw && qN === specialtyInitRaw) ||
  (qN && selectedSpecialtyValues.has(qN));

if (qDuplicatesSpecialty) {
  qEffective = "";       // prevents the üîé pill
  if (urlParams.has("q")) urlParams.delete("q");

  const next = urlParams.toString();
  const nextUrl = next ? `${window.location.pathname}?${next}` : window.location.pathname;
  window.history.replaceState({}, "", nextUrl);
}

// 3) Set the search input ONCE (after dedupe)
if (searchInput) searchInput.value = qEffective;


 

  // --- UI helpers ---
  function updateClearButton() {
    if (!clearBtn || !searchInput) return;
    const hasValue = !!searchInput.value.trim();
    clearBtn.classList.toggle("is-visible", hasValue);
  }

  function getActiveFilterCount() {
    let count = 0;
    if (neighborhoodSelect && neighborhoodSelect.value) count++;
    if (specialtySelect) count += specialtySelect.selectedOptions.length;
    if (amenitiesSelect) count += amenitiesSelect.selectedOptions.length;
    if (searchInput && searchInput.value.trim()) count++;
    return count;
  }

  function updateFilterCount() {
    const count = getActiveFilterCount();
    if (filterCount) {
      filterCount.textContent = String(count);
      filterCount.style.display = count > 0 ? "" : "none";
    }
  }

  // --- Sorting: only re-order DOM when sort changes ---
  let currentSort = sortSelect ? sortSelect.value : "az";

  function sortCardData(sortValue) {
    cardData.sort((a, b) => {
      if (sortValue === "az") return a.name.localeCompare(b.name);

      if (sortValue === "neighborhood") {
        return (
          a.firstNeighborhood.localeCompare(b.firstNeighborhood) ||
          a.name.localeCompare(b.name)
        );
      }

      if (sortValue === "type") {
        return a.type.localeCompare(b.type) || a.name.localeCompare(b.name);
      }

      return 0;
    });

    // Reorder DOM once using a fragment (fast)
    const frag = document.createDocumentFragment();
    cardData.forEach((x) => frag.appendChild(x.el));
    grid.appendChild(frag);
  }

  // --- Filtering: no sorting here, just hide/show ---
  let lastVisible = -1;

  function applyFilters() {
    const q = normalize(searchInput ? searchInput.value : "");
    const activeNeighborhood = normalize(neighborhoodSelect ? neighborhoodSelect.value : "");
    const activeSpecialties = getSelectedValues(specialtySelect);
    const activeAmenities = getSelectedValues(amenitiesSelect);

    const specialtyMode = getRadioValue("specialty-match", "any");     // any | all
    const amenitiesMode = getRadioValue("amenities-match", "any");  // any | all

    const selectedSpecialtyList = Array.from(activeSpecialties);
    const selectedAmenityList = Array.from(activeAmenities);

    let visible = 0;

    for (const d of cardData) {
      const matchesText = !q || d.searchBlob.includes(q);

      const matchesNeighborhood =
        !activeNeighborhood || d.neighborhoodsTokens.has(activeNeighborhood);

      

      const matchesSpecialty =
        selectedSpecialtyList.length === 0 ||
        (specialtyMode === "all"
          ? selectedSpecialtyList.every((s) => d.specialtyTokens.has(s))
          : selectedSpecialtyList.some((s) => d.specialtyTokens.has(s)));

      const matchesAmenity =
        selectedAmenityList.length === 0 ||
        (amenitiesMode === "all"
          ? selectedAmenityList.every((m) => d.amenityTokens.has(m))
          : selectedAmenityList.some((m) => d.amenityTokens.has(m)));

      const show = matchesText && matchesNeighborhood && matchesSpecialty && matchesAmenity;


      // Toggle display only if needed (reduces style churn)
      const newDisplay = show ? "" : "none";
      if (d.el.style.display !== newDisplay) d.el.style.display = newDisplay;

      if (show) visible++;
    }

    if (visible !== lastVisible) {
      lastVisible = visible;
      if (countEl) countEl.textContent = `Showing ${visible} place${visible === 1 ? "" : "s"}`;
      if (emptyState) emptyState.style.display = visible === 0 ? "block" : "none";
      grid.style.display = visible === 0 ? "none" : "";
    }

    updateClearButton();
    updateFilterCount();
   
    updateActiveFiltersSummary();
  }

  // --- Debounce typing (biggest perceived UX win) ---
  let debounceTimer = null;
  function debouncedApply() {
    if (debounceTimer) window.clearTimeout(debounceTimer);
    debounceTimer = window.setTimeout(applyFilters, 150);
  }

  // --- Mobile filter toggle ---
  if (filterToggle && filterPanel && filterToggleText) {
    filterToggle.addEventListener("click", () => {
      const isCollapsed = filterPanel.dataset.collapsed === "true";
      filterPanel.dataset.collapsed = isCollapsed ? "false" : "true";
      filterToggleText.textContent = isCollapsed ? "Hide filters" : "Show filters";
    });
  }

  function resetAllFilters() {
    if (searchInput) searchInput.value = "";
    if (neighborhoodSelect) neighborhoodSelect.value = "";
    if (specialtySelect) Array.from(specialtySelect.options).forEach((opt) => (opt.selected = false));
    if (amenitiesSelect) Array.from(amenitiesSelect.options).forEach((opt) => (opt.selected = false));

    const specialtyAny = document.querySelector('input[name="specialty-match"][value="any"]');
    const amenitiesAny = document.querySelector('input[name="amenities-match"][value="any"]');
    if (specialtyAny) specialtyAny.checked = true;
    if (amenitiesAny) amenitiesAny.checked = true;

    applyFilters();
  }

  // --- Listeners ---

  if (activeFiltersList) {
  activeFiltersList.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-clear]");
    if (!btn) return;

    const clearType = btn.dataset.clear;
    const value = btn.dataset.value;

    if (clearType === "neighborhood" && neighborhoodSelect) {
      neighborhoodSelect.value = "";
    } else if (clearType === "specialty" && specialtySelect) {
      Array.from(specialtySelect.options).forEach((opt) => {
        if (opt.value === value) opt.selected = false;
      });
    }  else if (clearType === "specialty-mode") {
  const any = document.querySelector('input[name="specialty-match"][value="any"]');
  if (any) any.checked = true;
    } else if (clearType === "amenity" && amenitiesSelect) {
      Array.from(amenitiesSelect.options).forEach((opt) => {
        if (opt.value === value) opt.selected = false;
      });
    } else if (clearType === "search" && searchInput) {
      searchInput.value = "";
    } else if (clearType === "amenities-mode") {
      const any = document.querySelector('input[name="amenities-match"][value="any"]');
      if (any) any.checked = true;
    }

    applyFilters();
  });
}

  if (searchInput) searchInput.addEventListener("input", debouncedApply);

  if (clearBtn && searchInput) {
    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      searchInput.focus();
      applyFilters();
    });
  }

  if (neighborhoodSelect) neighborhoodSelect.addEventListener("change", applyFilters);
  if (specialtySelect) specialtySelect.addEventListener("change", applyFilters);
  if (amenitiesSelect) amenitiesSelect.addEventListener("change", applyFilters);

  if (sortSelect) {
    sortSelect.addEventListener("change", () => {
      const next = sortSelect.value || "az";
      if (next !== currentSort) {
        currentSort = next;
        sortCardData(currentSort);
      }
      applyFilters();
    });
  }

  document.querySelectorAll('input[name="specialty-match"]').forEach((r) => {
    r.addEventListener("change", applyFilters);
  });
  document.querySelectorAll('input[name="amenities-match"]').forEach((r) => {
    r.addEventListener("change", applyFilters);
  });

  if (resetAllBtn) resetAllBtn.addEventListener("click", resetAllFilters);
  if (resetFromEmpty) resetFromEmpty.addEventListener("click", resetAllFilters);

  // Neighborhood chips
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".neighborhood-chip");
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    const slug = btn.dataset.neighborhoodSlug;
    if (!slug) return;

    window.location.href = `/neighborhood/${slug}/`;
  });

  // Init
  sortCardData(currentSort);
  updateClearButton();
  applyFilters();
})();
</script>


</BaseLayout>