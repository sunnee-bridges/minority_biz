---
// src/pages/business/[slug].astro
import BaseLayout from "../../layouts/Base.astro";
import { businesses } from "../../lib/businesses";

// Helper function for amenity icons (same as in [type].astro)
function getAmenityIcon(tag: string): string {
  const icons: Record<string, string> = {
    // existing
    takeout: "ü•°",
    "dine-in": "üçΩÔ∏è",
    "outdoor seating": "üå≥",
    delivery: "üöö",
    "vegan options": "üå±",
    "live entertainment": "üéµ",
    "lgbtq+ friendly": "üè≥Ô∏è‚Äçüåà",
    "wine and beer": "üç∑",
    "parking available": "üÖøÔ∏è",
    "pet-friendly patio": "üêæ",
    "live music": "üé∏",

    // dietary
    "100% vegan": "üå±",
    "dairy-free": "ü•õüö´",
    "gluten-free": "üåæüö´",
    "nut-free": "ü•úüö´",
    "soy-free": "ü´òüö´",
    halal: "‚ò™Ô∏è",
    "halal food": "‚ò™Ô∏è",
    vegetarian: "ü•ï",
    "vegetarian options": "ü•ï",
    "all-natural ingredients": "üçÉ",
    "dietary/allergy friendly": "üßë‚Äç‚öïÔ∏è",
    "dietary & allergy friendly": "üßë‚Äç‚öïÔ∏è",

    // food/service
    "accepts reservations": "üìÖ",
    reservations: "üìÖ",
    catering: "üç±",
    "curbside pickup": "üÖøÔ∏èüì¶",
    "drive-thru": "üöóüí®",
    "quick bite": "‚ö°Ô∏èüç¥",
    "small plates": "üçΩÔ∏è‚ú®",
    "happy hour": "‚è∞üçπ",
    alcohol: "üç∏",
    "bar onsite": "üç∫",
    "bar on-site": "üç∫",

    // accessibility + facilities
    "wheelchair accessible": "‚ôøÔ∏è",
    "gender-neutral restroom": "üöª",
    "transgender safespace": "üè≥Ô∏è‚Äç‚ößÔ∏è",
    "transgender safe space": "üè≥Ô∏è‚Äç‚ößÔ∏è",
    "high chairs": "üë∂",
    "kids‚Äô menu": "üßí",
    "kids menu": "üßí",
    "family-friendly": "üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
    "groups welcome": "üë•",

    // parking/transport
    "bike parking": "üö≤",
    "free parking": "üÜìüÖøÔ∏è",
    "valet parking": "üÖøÔ∏èü§µ",

    // vibes / extras
    "heated outdoor seating": "üî•üå≥",
    "pool table": "üé±",
    "juke box": "üìª",
    tourists: "üß≥",
    philanthropic: "ü§ù",
    "veteran owned": "üéñÔ∏è",

    // retail / market / goods
    "specialty market": "üõí",
    "african groceries": "üõíüåç",
    "caribbean groceries": "üõíüå¥",
    "imported goods": "üì¶üåç",
    "cultural products": "üè∫",
    "fabrics and jewelry": "üßµüíé",

    // art / studio / handmade
    "studio services": "üé¨",
    "handmade dishes": "ü´∂üçΩÔ∏è",
    "plant-based soul food": "üå±üç≤",
  };

  return icons[(tag || "").toLowerCase().trim()] || "‚úì";
}

// üîë Tell Astro which /business/[slug]/ pages to generate
export function getStaticPaths() {
  return businesses
    .filter((b) => !!b?.slug)
    .map((b) => ({
      params: { slug: b.slug },
    }));
}

function slugify(str: string) {
  return String(str || "")
    .toLowerCase()
    .trim()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");
}

function toTitleCase(str: string): string {
  return String(str || "")
    .toLowerCase()
    .split(/\s+/)
    .filter(Boolean)
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

function truncate(str: string, max = 160) {
  const s = String(str || "").replace(/\s+/g, " ").trim();
  if (!s) return "";
  return s.length > max ? s.slice(0, max - 1).trimEnd() + "‚Ä¶" : s;
}

/**
 * ‚úÖ Low-headache schema:
 * - Restaurant gets Restaurant
 * - Everything else = LocalBusiness (future-proof for art/fitness/etc.)
 */
function schemaTypesFor(typeSlug: string): string[] {
  const t = (typeSlug || "").toLowerCase();
  if (t === "restaurant") return ["LocalBusiness", "Restaurant"];
  return ["LocalBusiness"];
}

const { slug } = Astro.params;
const business = businesses.find((b) => b.slug === slug);

const notFound = !business;

if (notFound) {
  Astro.response.status = 404;
}

// -------------------------
// ‚úÖ SEO + JSON-LD (robust + future-proof)
// -------------------------
const origin =
  import.meta.env.SITE_URL ||
  Astro.site ||
  Astro.url.origin;

const siteUrl = new URL("/", origin).toString();

const canonicalPath = (Astro.url.pathname || "/").replace(/\/$/, "") || "/";
const canonical = new URL(canonicalPath, origin).toString();

const pageImage = "/og-denver-black-guide.png";
const absoluteImage = new URL(pageImage, origin).toString();

let pageTitle = "Business Not Found ‚Ä¢ Denver Black Guide";
let pageDescription = "We couldn‚Äôt find that business.";

let typeSlug = "other";
let displayTypeLabel = "Business";

// --- Specialty display (show a few, then +count) ---
const MAX_SPECIALTIES_SHOWN = 3; // change to 2 if you want fewer shown
let specialtiesShown: string[] = [];
let specialtiesRemaining = 0;
let specialtiesFullLabel = "";


let displayTypes: string[] = [];
let primaryFacetLabel = "Specialties";

let neighborhoods: string[] = [];
let neighborhoodLabel = "Denver";

if (!notFound && business) {
  const businessType =
    business.type ||
    (Array.isArray(business.businessCategories) && business.businessCategories[0]) ||
    "Other";

  typeSlug = slugify(businessType) || "other";
  displayTypeLabel = toTitleCase(businessType) || "Business";

  const isRestaurant = typeSlug === "restaurant";

  displayTypes = business.specialties || [];
  primaryFacetLabel = "Specialties";

  // --- Specialty display (show a few, then +count) ---
specialtiesShown = displayTypes.slice(0, MAX_SPECIALTIES_SHOWN);
specialtiesRemaining = Math.max(0, displayTypes.length - specialtiesShown.length);
specialtiesFullLabel = displayTypes.join(", ");


  neighborhoods = Array.isArray(business.neighborhoods) ? business.neighborhoods : [];
  neighborhoodLabel = neighborhoods.length ? neighborhoods.join(", ") : "Denver";

  const typeLabel = displayTypeLabel || "Business";
  const facetLabel =
    displayTypes.length > 0 ? `${primaryFacetLabel}: ${displayTypes.join(", ")}` : typeLabel;

  pageTitle = `${business.name} | ${typeLabel} in ${neighborhoodLabel} ‚Ä¢ Denver Black Guide`;

  pageDescription =
    truncate(business.notes ?? "", 160) ||
    truncate(
      `${business.name} is a Black-owned ${typeLabel.toLowerCase()} in ${neighborhoodLabel}. ${facetLabel}. View contact info, amenities, and location on the Denver Black Guide.`,
      160
    );
}

// ‚úÖ If you have per-business images, prefer them for OG + schema
const businessImage =
  !notFound && business && (business as any).image
    ? new URL((business as any).image, origin).toString()
    : absoluteImage;

const imageForMeta =
  !notFound && business && (business as any).image
    ? (String((business as any).image).startsWith("http")
        ? String((business as any).image)
        : String((business as any).image))
    : pageImage;

// ‚úÖ Denver address is safe for now and works for restaurants + future categories
const denverAddress = {
  "@type": "PostalAddress",
  addressLocality: "Denver",
  addressRegion: "CO",
  addressCountry: "US",
};

// Business structured data
const schemaTypes = schemaTypesFor(typeSlug);

const businessId = `${canonical}#business`;
const breadcrumbId = `${canonical}#breadcrumb`;

const businessJsonLd =
  !notFound && business
    ? {
        "@id": businessId,
        "@type": schemaTypes, // e.g. ["LocalBusiness","Restaurant"]
        name: business.name,
        url: canonical,
        mainEntityOfPage: canonical,
        image: businessImage,
        address: denverAddress,
        areaServed: { "@type": "City", name: "Denver" },

        ...(business.phone ? { telephone: business.phone } : {}),
        ...(business.website ? { sameAs: [business.website] } : {}),

        ...(schemaTypes.includes("Restaurant") && business.specialties?.length
          ? { servesCuisine: business.specialties.slice(0, 8) }
          : {}),

        ...(business.latitude && business.longitude
          ? {
              geo: {
                "@type": "GeoCoordinates",
                latitude: business.latitude,
                longitude: business.longitude,
              },
            }
          : {}),
      }
    : null;

const breadcrumbJsonLd = {
  "@id": breadcrumbId,
  "@type": "BreadcrumbList",
  itemListElement: !notFound && business
    ? [
        { "@type": "ListItem", position: 1, name: "Home", item: siteUrl },
        {
          "@type": "ListItem",
          position: 2,
          name: displayTypeLabel,
          item: new URL(`/type/${typeSlug}`, origin).toString(),
        },
        { "@type": "ListItem", position: 3, name: business.name, item: canonical },
      ]
    : [
        { "@type": "ListItem", position: 1, name: "Home", item: siteUrl },
      ],
};

const jsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "WebPage",
      name: pageTitle,
      url: canonical,
      description: pageDescription,
      primaryImageOfPage: {
        "@type": "ImageObject",
        url: businessImage,
      },
      // wire to Base.astro global ids (nice but optional)
      isPartOf: { "@id": `${siteUrl}#website`},
      publisher: { "@id": `${siteUrl}#organization` },

      breadcrumb: { "@id": breadcrumbId },
    },
    ...(businessJsonLd ? [businessJsonLd] : []),
    breadcrumbJsonLd,
  ],
};

const robots = notFound
  ? "noindex,follow"
  : "index,follow,max-image-preview:large";
---

<BaseLayout
  title={pageTitle}
  description={pageDescription}
  canonical={canonical}
  image={imageForMeta}
  jsonLd={jsonLd}
  robots={robots}
  ogType="website"
  ogImageAlt={!notFound && business
    ? `${business.name} listing on Denver Black Guide`
    : "Denver Black Guide directory preview image"}
>
  
    <meta slot="head" name="twitter:label1" content="Category" />
    <meta slot="head" name="twitter:data1" content={displayTypeLabel} />
  

  {notFound ? (
    <div style="padding:2rem 0; max-width: 820px; margin: 0 auto;">
      <h1>Business not found</h1>
      <p>We couldn‚Äôt find that business.</p>
      <p><a href="/all">Browse all businesses ‚Üí</a></p>
    </div>
  ) : (
    <>
      <div class="business-detail">
        {/* üß≠ Breadcrumb */}
        <nav class="business-detail__breadcrumb" aria-label="Breadcrumb">
          <div class="business-detail__breadcrumb-row">
            <a href="/" class="business-detail__breadcrumb-link">Home</a>
            <span class="business-detail__breadcrumb-separator">/</span>
            <a href={`/type/${typeSlug}`} class="business-detail__breadcrumb-link">
              {displayTypeLabel}
            </a>
            <span class="business-detail__breadcrumb-separator">/</span>
            <span aria-current="page">{business!.name}</span>
          </div>
        </nav>

        {/* "Back to results" */}
        <a
          href={`/type/${typeSlug}`}
          class="business-detail__back"
          onclick="if (window.history.length > 1) { history.back(); return false; }"
        >
          ‚Üê Back to results
        </a>

        <article class="business-detail__card">
          <header class="business-detail__header">
            <h1 class="business-detail__name">{business!.name}</h1>

            {displayTypes.length > 0 && (
              <p class="business-detail__meta" title={specialtiesFullLabel}>
                <span class="business-detail__meta-label">{primaryFacetLabel}:</span>{" "}
                <span>
                  {specialtiesShown.join(", ")}
                  {specialtiesRemaining > 0 && (
                    <span class="business-detail__meta-more">
                      {" "}+{specialtiesRemaining} more
                    </span>
                  )}
                </span>
              </p>
            )}


            {business!.businessCategories && business!.businessCategories.length > 0 && (
              <p class="business-detail__meta">{business!.businessCategories.join(", ")}</p>
            )}

            <p class="business-detail__meta business-detail__meta--location">
              <span class="quick-info-icon">üìç</span>

              {Array.isArray(business!.neighborhoods) && business!.neighborhoods.length > 0 ? (
                business!.neighborhoods.map((n, idx) => (
                  <>
                    <a
                      href={`/neighborhood/${slugify(n)}`}
                      class="business-detail__neighborhood-link"
                    >
                      {n}
                    </a>
                    {idx < business!.neighborhoods.length - 1 && <span>, </span>}
                  </>
                ))
              ) : (
                <span>Denver</span>
              )}
            </p>

            {/* Get Directions Button */}
            {business!.latitude && business!.longitude && (
              <a
                href={`https://www.google.com/maps/search/?api=1&query=${business!.latitude},${business!.longitude}`}
                target="_blank"
                rel="noopener noreferrer"
                class="action-btn action-btn--primary business-detail__directions-btn"
              >
                <span class="action-btn__icon">üìç</span>
                <span>Get Directions</span>
              </a>
            )}
          </header>

          <section class="business-detail__body">
            {/* Contact Info Section */}
            {(business!.website || business!.phone) && (
              <div class="business-detail__section">
                <h2 class="business-detail__section-title">Contact Information</h2>

                {business!.website && (
                  <p class="business-detail__row">
                    <span class="business-detail__label">
                      <span class="business-detail__icon">üåê</span>
                      Website:
                    </span>{" "}
                    <a
                      href={business!.website}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="business-detail__link"
                    >
                      {String(business!.website).replace(/^https?:\/\//, "")}
                      <span class="external-link-icon">‚Üó</span>
                    </a>
                  </p>
                )}

                {business!.phone && (
                  <p class="business-detail__row">
                    <span class="business-detail__label">
                      <span class="business-detail__icon">üìû</span>
                      Phone:
                    </span>{" "}
                    <a href={`tel:${business!.phone}`} class="business-detail__link">
                      {business!.phone}
                    </a>
                  </p>
                )}
              </div>
            )}

            {/* Amenities Section */}
            {business!.microfilters && business!.microfilters.length > 0 && (
              <div class="business-detail__section">
                <h2 class="business-detail__section-title">Amenities &amp; Options</h2>
                <div class="business-detail__amenities-grid">
                  {business!.microfilters.map((tag) => (
                    <div class="amenity-item">
                      <span class="amenity-item__icon">{getAmenityIcon(tag)}</span>
                      <span class="amenity-item__label">{tag}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* About Section */}
            {business!.notes && (
              <div class="business-detail__section">
                <h2 class="business-detail__section-title">About</h2>
                <p class="business-detail__notes">{business!.notes}</p>
              </div>
            )}

            {/* Map Section */}
            {business!.latitude && business!.longitude && (
              <div class="business-detail__section">
                <h2 class="business-detail__section-title">Location</h2>
                <div class="business-detail__map-container">
                  <div id="detail-map" class="business-detail__map"></div>
                </div>
              </div>
            )}
          </section>
        </article>
      </div>

      <style>
        .business-detail {
          max-width: 820px;
          margin: 0 auto;
          padding-block: 1.5rem 3rem;
        }

        .business-detail__meta-more {
          font-weight: 600;
          color: var(--text-muted);
        }


        /* Breadcrumb */
        .business-detail__breadcrumb {
          font-size: 0.75rem;
          color: var(--text-muted);
          margin-bottom: 0.5rem;
        }

        .business-detail__breadcrumb-row {
          display: flex;
          flex-wrap: wrap;
          gap: 0.25rem;
          align-items: center;
        }

        .business-detail__breadcrumb-link {
          text-decoration: none;
          color: var(--text-muted);
          transition: color 0.15s;
        }

        .business-detail__breadcrumb-link:hover {
          text-decoration: underline;
          color: var(--accent-strong);
        }

        .business-detail__breadcrumb-separator {
          margin: 0 0.1rem;
          opacity: 0.6;
        }

        .business-detail__back {
          display: inline-block;
          margin-bottom: 1rem;
          font-size: 0.85rem;
          color: var(--text-muted);
          text-decoration: none;
          transition: color 0.15s;
        }

        .business-detail__back:hover {
          color: var(--accent-strong);
          text-decoration: underline;
        }

        .business-detail__card {
          padding: 2rem 2.5rem 2.5rem;
          box-shadow: var(--shadow-soft);
        }

        .business-detail__header {
          margin-bottom: 1.5rem;
          padding-bottom: 1.5rem;
          border-bottom: 1px solid var(--border-subtle);
        }

        .business-detail__directions-btn {
          margin-top: 1rem;
          display: inline-flex;
        }

        .business-detail__name {
          margin: 0 0 0.75rem;
          font-size: 2rem;
          line-height: 1.2;
          color: var(--text-main);
        }

        .business-detail__meta {
          margin: 0.35rem 0;
          font-size: 0.95rem;
          color: var(--text-muted);
          line-height: 1.5;
        }

        .business-detail__meta-label {
          font-weight: 600;
          color: var(--text-main);
        }

        .business-detail__meta--location {
          display: flex;
          align-items: center;
          gap: 0.35rem;
          flex-wrap: wrap;
        }

        .business-detail__neighborhood-link {
          color: var(--accent-strong);
          text-decoration: none;
        }

        .business-detail__neighborhood-link:hover {
          color: var(--accent);
          text-decoration: underline;
        }

        .quick-info-icon {
          font-size: 0.9rem;
        }

        /* Action Button */
        .action-btn {
          display: inline-flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.75rem 1.5rem;
          border-radius: 0.5rem;
          font-size: 0.9rem;
          font-weight: 600;
          text-decoration: none;
          transition: all 0.2s;
          border: 1px solid transparent;
        }

        .action-btn--primary {
          background: var(--accent);
          color: white;
          border-color: var(--accent);
        }

        .action-btn--primary:hover {
          background: var(--accent-strong);
          transform: translateY(-1px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .action-btn__icon {
          font-size: 1.1rem;
        }

        /* Body Sections */
        .business-detail__body {
          display: flex;
          flex-direction: column;
          gap: 2rem;
        }

        .business-detail__section {
          display: flex;
          flex-direction: column;
          gap: 0.75rem;
        }

        .business-detail__section-title {
          margin: 0;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          font-size: 0.85rem;
          color: var(--text-muted);
        }

        .business-detail__row {
          margin: 0;
          display: flex;
          align-items: baseline;
          gap: 0.5rem;
          flex-wrap: wrap;
        }

        .business-detail__label {
          font-weight: 600;
          color: var(--text-main);
          display: inline-flex;
          align-items: center;
          gap: 0.35rem;
          min-width: 90px;
        }

        .business-detail__icon {
          font-size: 1rem;
        }

        .business-detail__link {
          color: var(--accent-strong);
          text-decoration: none;
          transition: color 0.15s;
          display: inline-flex;
          align-items: center;
          gap: 0.25rem;
        }

        .business-detail__link:hover {
          color: var(--accent);
          text-decoration: underline;
        }

        .external-link-icon {
          font-size: 0.8rem;
          opacity: 0.7;
        }

        /* Amenities Grid */
        .business-detail__amenities-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 0.75rem;
        }

        .amenity-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.6rem 0.85rem;
          background: var(--bg-elevated);
          border: 1px solid var(--border-subtle);
          border-radius: 0.5rem;
          font-size: 0.85rem;
          transition: all 0.15s;
        }

        .amenity-item:hover {
          border-color: var(--accent);
          background: var(--accent-soft);
        }

        .amenity-item__icon {
          font-size: 1.2rem;
          flex-shrink: 0;
        }

        .amenity-item__label {
          color: var(--text-main);
          font-weight: 500;
        }

        /* Notes/About */
        .business-detail__notes {
          margin: 0;
          font-size: 1rem;
          line-height: 1.7;
          color: var(--text-main);
        }

        /* Map */
        .business-detail__map-container {
          border-radius: 0.75rem;
          overflow: hidden;
          border: 1px solid var(--border-subtle);
        }

        .business-detail__map {
          width: 100%;
          height: 400px;
          background: var(--bg-elevated);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
          .business-detail__card {
            padding: 1.5rem 1.25rem;
          }

          .business-detail__name {
            font-size: 1.6rem;
          }

          .business-detail__directions-btn {
            width: 100%;
            justify-content: center;
          }

          .business-detail__amenities-grid {
            grid-template-columns: 1fr;
          }

          .business-detail__map {
            height: 300px;
          }
        }

        @media (max-width: 640px) {
          .business-detail {
            padding-inline: 0.5rem;
          }

          .business-detail__card {
            padding: 1.25rem 1rem;
          }

          .business-detail__name {
            font-size: 1.4rem;
          }
        }
      </style>

      {business!.latitude && business!.longitude && (
        <script
          is:inline
          define:vars={{
            businessLat: business!.latitude,
            businessLng: business!.longitude,
            businessName: business!.name,
            businessNeighborhood: business!.neighborhoods?.[0] || "Denver",
          }}
        >
          // Initialize map when page loads
          window.addEventListener("load", function () {
            if (typeof window.L === "undefined") {
              console.error("Leaflet not loaded");
              return;
            }

            const mapElement = document.getElementById("detail-map");
            if (!mapElement) return;

            try {
              // Create map centered on business location
              const map = window.L.map("detail-map").setView([businessLat, businessLng], 15);

              // Add tile layer
              window.L.tileLayer(
                "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
                {
                  attribution:
                    '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ¬© <a href="https://carto.com/attributions">CARTO</a>',
                  maxZoom: 19,
                }
              ).addTo(map);

              // Custom marker
              const customIcon = window.L.divIcon({
                className: "custom-marker",
                html: '<div style="background: var(--accent); width: 32px; height: 32px; border-radius: 50%; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
              });

              // Add marker
              const marker = window.L.marker([businessLat, businessLng], {
                icon: customIcon,
              }).addTo(map);

              // Create popup content
              const popupContent =
                '<div style="padding: 0.5rem;">' +
                '<h3 style="margin: 0 0 0.25rem; font-size: 0.95rem; font-weight: 600;">' +
                businessName +
                "</h3>" +
                '<p style="margin: 0; font-size: 0.75rem; color: #666;">' +
                businessNeighborhood +
                "</p>" +
                "</div>";

              marker.bindPopup(popupContent).openPopup();
            } catch (error) {
              console.error("Error initializing map:", error);
            }
          });
        </script>
      )}
    </>
  )}
</BaseLayout>
