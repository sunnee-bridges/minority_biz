---
// src/layouts/Base.astro
import "../styles/global.css";
import Footer from "../components/Footer.astro";

const {
  title = "Denver Black Guide",
  description = "A community-driven directory to discover and support Black-owned businesses in the Denver metro area.",
  image = "/og-denver-black-guide.png", // safe fallback
  canonical: canonicalProp,
  jsonLd, // page-specific JSON-LD (optional)
  robots = "index,follow,max-image-preview:large",
} = Astro.props;

// Prefer Astro.site (from astro.config.mjs). Fallback to current origin.
const origin = Astro.site ?? Astro.url.origin;
const siteUrl = new URL("/", origin).toString();

const canonical = canonicalProp
  ? canonicalProp
  : new URL(Astro.url.pathname, origin).toString();

const absoluteImage = new URL(image, origin).toString();

/**
 * Safely serialize JSON-LD for <script type="application/ld+json">
 * - Escapes <, >, & to avoid edge-case parsing / </script> hazards.
 * - Escapes U+2028/U+2029 which can break JS parsing in some contexts.
 */
function safeJsonLd(data: unknown) {
  return JSON.stringify(data)
    .replace(/</g, "\\u003c")
    .replace(/>/g, "\\u003e")
    .replace(/&/g, "\\u0026")
    .replace(/\u2028/g, "\\u2028")
    .replace(/\u2029/g, "\\u2029");
}

// Always-present global structured data
const globalJsonLd = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": `${siteUrl}#organization`,
      name: "Denver Black Guide",
      url: siteUrl,
      // If you have a true logo asset, uncomment and use it:
      // logo: new URL("/logo.png", origin).toString(),
    },
    {
      "@type": "WebSite",
      "@id": `${siteUrl}#website`,
      url: siteUrl,
      name: "Denver Black Guide",
      publisher: { "@id": `${siteUrl}#organization` },
      potentialAction: {
        "@type": "SearchAction",
        target: `${new URL("/all", origin).toString()}?q={search_term_string}`,
        "query-input": "required name=search_term_string",
      },
    },
  ],
};
---

<html lang="en" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <meta name="robots" content={robots} />

    <link rel="canonical" href={canonical} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    <meta property="og:image" content={absoluteImage} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={absoluteImage} />

    <!-- ‚úÖ JSON-LD: global (always) -->
    <script type="application/ld+json" set:html={safeJsonLd(globalJsonLd)} />

    <!-- ‚úÖ JSON-LD: page-specific (optional) -->
    {jsonLd && (
      <script type="application/ld+json" set:html={safeJsonLd(jsonLd)} />
    )}

    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Extra head slot -->
    <slot name="head" />

    <!-- initial theme -->
    <script is:inline>
      (function () {
        try {
          const stored = localStorage.getItem("theme");
          const prefersDark =
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches;
          const theme = stored || (prefersDark ? "dark" : "light");
          document.documentElement.dataset.theme = theme;
        } catch (e) {
          document.documentElement.dataset.theme = "light";
        }
      })();
    </script>
  </head>

  <body>
    <header class="site-header">
      <div class="shell site-header__inner">
        <a href="/" class="site-header__brand">
          <span class="site-header__logo" aria-hidden="true">üçΩÔ∏è</span>
          <span class="site-header__title">Denver Black Guide</span>
        </a>

        <nav class="site-header__nav" aria-label="Primary navigation">
          <a href="/about" class="site-header__link">About</a>
          <a href="/contact" class="site-header__link">Contact</a>

          <button
            id="themeToggle"
            type="button"
            class="theme-toggle"
            aria-label="Toggle color theme"
            aria-pressed="false"
          >
            <span class="theme-toggle__icon" aria-hidden="true">üåû</span>
            <span class="theme-toggle__label">Light</span>
          </button>
        </nav>
      </div>
    </header>

    <!-- üåÑ Denver skyline hero image -->
    <div class="site-hero" aria-hidden="false">
      <img
        src="/denver-skyline-v1.png"
        alt="Watercolor illustration of the Denver skyline with mountains at sunset"
        class="site-hero__image"
      />
    </div>

    <main class="shell site-main">
      <slot />
    </main>

    <Footer />

    <!-- theme toggle logic -->
    <script is:inline>
      (function () {
        const root = document.documentElement;
        const btn = document.getElementById("themeToggle");
        if (!btn) return;

        function getTheme() {
          return root.dataset.theme === "dark" ? "dark" : "light";
        }

        function applyTheme(theme) {
          root.dataset.theme = theme;
          try {
            localStorage.setItem("theme", theme);
          } catch (e) {}

          const icon = btn.querySelector(".theme-toggle__icon");
          const label = btn.querySelector(".theme-toggle__label");

          if (theme === "dark") {
            btn.setAttribute("aria-pressed", "true");
            if (icon) icon.textContent = "üåô";
            if (label) label.textContent = "Dark";
          } else {
            btn.setAttribute("aria-pressed", "false");
            if (icon) icon.textContent = "üåû";
            if (label) label.textContent = "Light";
          }
        }

        applyTheme(getTheme());

        btn.addEventListener("click", () => {
          const next = getTheme() === "dark" ? "light" : "dark";
          applyTheme(next);
        });
      })();
    </script>
  </body>
</html>
